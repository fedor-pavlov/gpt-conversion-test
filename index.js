////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////// BOT PREREQUISITS /////////////////////////////////////////////////////////////////////////////////

const   OCONNECT        = require('../../odb');
const   BOT_FATHER      = require('../bot_father');
const { SOURCE_ID,
        SOURCE_TITLE  } = require('./constants');
const   trace           = require('../../tracer').create({ title: SOURCE_TITLE, source: SOURCE_ID });
const   mw              = require('./middleware');





////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////// BOT INITITALIZATION //////////////////////////////////////////////////////////////////////////////

function attach_db(bot, oDB) {

    Object.defineProperty(bot.context, 'db', {

        configurable    : false,
        enumerable      : true,
        writable        : false,
        value           : oDB
    })

    Object.defineProperty(bot, 'db', {

        configurable    : false,
        enumerable      : false,
        writable        : false,
        value           : oDB
    })

    return oDB
}





////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////// MODULE EXPORTS ///////////////////////////////////////////////////////////////////////////////////

module.exports = class SosedPresnyaBot extends BOT_FATHER {

    constructor(token) {

        super(token, { tracer: trace });
        mw.install(this);
    }

    run(options) {

        let db_options = Object.assign({}, options.db, {

            wrapper : require('./db')
        })

        return OCONNECT(db_options)
            .then(db => attach_db(this, db))
            .then(() => super.run(options))
    }
}