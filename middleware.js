////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////// MODULE PREREQUISITS //////////////////////////////////////////////////////////////////////////////

const	TELEGRAF      		= require('telegraf');
const { SOURCE_ID,
		SOURCE_TITLE,
		CLASSES,
        SETTINGS        }   = require('./constants');
const { messages,
        actions,
        decode_callback,
        broadcast,
        say             }   = require('./speech');
const   stage               = require('./scenes');
const   session             = require('telegraf/session');
const   user_session        = require('./db/session');
const   trace               = require('../../tracer').create({ title: SOURCE_TITLE + '[MIDDLEWARE]', source: SOURCE_ID });
const { toString,
        access_card_id }    = require('../../tools');
const   support             = "@fedor_pavlov";
const 	Extra				= require('telegraf/extra');
const 	Markup				= require('telegraf/markup');
const { toText }            = require('object-to-text');
const   oUser               = require('./db/user')





////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////// OBSOLETE DEPENDCIES //////////////////////////////////////////////////////////////////////////////

const REX_APPT	= /^(1\d\d\d|\d{1,3})$/i;
const REX_APP2	= /\b(9[123]\d\d|1\d\d\d|\d{1,3})\b/gi;
const REX_THNX	= /^—Å–ø–∞—Å–∏–±.*/i;
const REX_CONF	= /^\{"accept-doc":\{.+\}\}$/i;
const REX_RECV	= /^\{"recieve-money":\{.+\}\}$/i;
const REX_FILM	= /^\{"film":\{.+\}\}$/i;
const REX_RELS	= /^[1-9]\d{8}$/i;
const REX_ESTR	= /–•—Ä–∏—Å—Ç–æ—Å\s*–í–æ—Å–∫—Ä–µ—Å/i;
const REX_MENU	= /^(\/\#\\)?(–º–µ–Ω—é|menu)/i;

const USR_SUPP	= 771172117;
const USR_ZOTOV = 1*(process.env.USR_ZOTV ||  776914784);
const USR_NICKY = 1*(process.env.USR_NICK ||  52984194);
const CHT_LOGS	= 1*(process.env.CHT_LOGS || -338913683);
const CHT_ATTN	= 1*(process.env.CHT_ATTN || -1001214733932);
const CHT_PRIV	= 1*(process.env.CHT_PRIV || -1001372113776);
const CHT_LAWR	= -1001400315794;
const CHT_CASH	= 1*(process.env.CHT_CASH || -1001263903912);
const CHT_NEWS	= 1*(process.env.CHT_NEWS || -338797486);
const CHT_FILM	= -1001342517700;
const CHT_SYST	= [CHT_LOGS, CHT_ATTN, CHT_NEWS, CHT_CASH, CHT_FILM, -1001179410682];

const MAX_MSPS	= 15;
const TM_SLEEP	= 1000;
const TM_DELET	= 15000;
const MNY_SUMM	= 1000;
const MNY_DISP	= 6;

const BOT_QUIZ = {

	11:	{	msg: `<i>–ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è, –Ω–æ —è —Å–ª—É—á–∞–π–Ω–æ —Å—Ç—ë—Ä –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –ø–æ 1-–º—É –∏ 2-–º—É –≤–æ–ø—Ä–æ—Å–∞–º.\n\n–ü—Ä–æ—Å—Ç–∏—Ç–µ.\n\n–ï—Å–ª–∏ –Ω–µ –∑–∞—Ç—Ä—É–¥–Ω–∏—Ç, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 1-–π –∏ 2-–π –≤–æ–ø—Ä–æ—Å—ã –µ—â–µ —Ä–∞–∑, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:</i>\n\n<b>–í–æ–ø—Ä–æ—Å 1:</b>\n–ì–æ–ª–æ—Å–æ–≤–∞–ª–∏ –ª–∏ –í—ã –ø–æ –ø–µ—Ä–≤–æ–º—É —Å–æ–±—Ä–∞–Ω–∏—é, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–æ —Å 01.04 –ø–æ 31.05?`,
			extra: Extra.HTML().markup(m => m.inlineKeyboard([
				[Markup.callbackButton("–î–∞, –≥–æ–ª–æ—Å–æ–≤–∞–ª",		`{"vote-fix":{"id":11,"answer":"yes"}}`)],
				[Markup.callbackButton("–ù–µ—Ç, –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª",	`{"vote-fix":{"id":11,"answer":"no"}}`)],
			]))
		},
	12: {	msg: `<b>–í–æ–ø—Ä–æ—Å 2:</b>\n–ì–æ–ª–æ—Å–æ–≤–∞–ª–∏ –ª–∏ –í—ã –ø–æ –≤—Ç–æ—Ä–æ–º—É —Å–æ–±—Ä–∞–Ω–∏—é, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å, —Å 28.05 –ø–æ 21.06?`,
			extra: Extra.HTML().markup(m => m.inlineKeyboard([

				[Markup.callbackButton("–î–∞, —É–∂–µ",						`{"vote-fix":{"id":2,"answer":"yes"}}`)],
				[Markup.callbackButton("–ù–µ—Ç, –Ω–æ –¥–æ 21.06 –µ—â—ë —É—Å–ø–µ—é",	`{"vote-fix":{"id":2,"answer":"not yet"}}`)],
				[Markup.callbackButton("–ù–µ—Ç, –∏ –Ω–µ –ø–ª–∞–Ω–∏—Ä—É—é",			`{"vote-fix":{"id":2,"answer":"no plans"}}`)],
				[Markup.callbackButton("–ù–µ –∑–Ω–∞—é, –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å",		`{"vote-fix":{"id":2,"answer":"how"}}`)],
			]))
		},
	2:	{	msg: `<b>–í–æ–ø—Ä–æ—Å 2 –∏–∑ 4:</b>\n–ì–æ–ª–æ—Å–æ–≤–∞–ª–∏ –ª–∏ –í—ã –ø–æ –≤—Ç–æ—Ä–æ–º—É —Å–æ–±—Ä–∞–Ω–∏—é, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å, —Å 28.05 –ø–æ 21.06?`,
			extra: Extra.HTML().markup(m => m.inlineKeyboard([

				[Markup.callbackButton("–î–∞, —É–∂–µ",						`{"vote":{"id":2,"answer":"yes"}}`)],
				[Markup.callbackButton("–ù–µ—Ç, –Ω–æ –¥–æ 21.06 –µ—â—ë —É—Å–ø–µ—é",	`{"vote":{"id":2,"answer":"not yet"}}`)],
				[Markup.callbackButton("–ù–µ—Ç, –∏ –Ω–µ –ø–ª–∞–Ω–∏—Ä—É—é",			`{"vote":{"id":2,"answer":"no plans"}}`)],
				[Markup.callbackButton("–ù–µ –∑–Ω–∞—é, –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å",		`{"vote":{"id":2,"answer":"how"}}`)],
			]))
		},
	3:	{	msg: `<b>–í–æ–ø—Ä–æ—Å 3 –∏–∑ 4:</b>\n–ö–∞–∫–æ–≥–æ —á–∏—Å–ª–∞ –í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏ –∞–∫—Ç-–ø—Ä–∏–µ–º–∞ –ø–µ—Ä–µ–¥–∞—á–∏ (–∏–ª–∏ –¥—Ä—É–≥–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏)?\n\n<i>–í–æ–ø—Ä–æ—Å —Å–≤—è–∑–∞–Ω –≤–æ—Ç —Å —á–µ–º:\n–µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è, —á—Ç–æ –∑–∞ –í–∞—Å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫, —Ç–æ –¥–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏ –Ω–∞–¥–æ –∏–º–µ—Ç—å –∫–∞–∫–æ–µ-–ª–∏–±–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —Å–æ–≥–ª–∞—Å–Ω–æ –∫–æ—Ç–æ—Ä–æ–º—É –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫ –Ω–µ –∏–º–µ–ª –ø—Ä–∞–≤–æ —ç—Ç–æ–≥–æ –¥–µ–ª–∞—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä, –í—ã —É—Å–ø–µ–ª–∏ –ø–æ–¥–ø–∏—Å–∞—Ç—å –ê–ü–ü –¥–æ 31-–≥–æ –º–∞—è - —ç—Ç–æ —Ö–æ—Ä–æ—à–µ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫—É –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ –í–∞—Å.</i>`,
			extra: Extra.HTML().markup(m => m.inlineKeyboard([				

				[Markup.callbackButton("—É –º–µ–Ω—è –ø–æ–¥–ø–∏—Å–∞–Ω –ê–ü–ü",			`{"docs":{"type":"app"}}`)],
				[Markup.callbackButton("—É –º–µ–Ω—è –µ—Å—Ç—å –î–ö–ü",				`{"docs":{"type":"dkp"}}`)],
				[Markup.callbackButton("—É –º–µ–Ω—è –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –ü–î–ö–ü",		`{"docs":{"type":"pdkp"}}`)],
				[Markup.callbackButton("—É –º–µ–Ω—è –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –î–î–£",		`{"docs":{"type":"ddu"}}`)],
				[Markup.callbackButton("—É –º–µ–Ω—è –µ—Å—Ç—å —á—Ç–æ-—Ç–æ –ø–æ–ª—É—á—à–µ",	`{"docs":{"type":"other"}}`)],
				[Markup.callbackButton("–≤–æ–æ–±—â–µ –Ω–µ –ø–æ–Ω—è—Ç–Ω–æ –æ —á–µ–º —ç—Ç–æ",	`{"docs":{"type":"why"}}`)]
			]))
		},
	4:	{	msg: `<b>–í–æ–ø—Ä–æ—Å 4 –∏–∑ 4:</b>\n–ö–∞–∫ –Ω–∏ —Å—Ç—Ä–∞–Ω–Ω–æ, –≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏ —É—á–∞—Å—Ç–≤—É—é—Ç –Ω–µ –ª—é–¥–∏, –∞ –º–µ—Ç—Ä—ã. –ù–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–ª–∏—è–µ—Ç –æ–±—â–∞—è –ø–ª–æ—â–∞–¥—å –≤—Å–µ–π –≤–∞—à–µ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –í —Ç–æ–º —á–∏—Å–ª–µ –ø–∞—Ä–∫–æ–≤–∫–∏ –∏ –∫–ª–∞–¥–æ–≤–∫–∏. –ï—Å–ª–∏ –≤—ã –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ, —Ç–æ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫ –º–æ–≥ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –≤–∞—à–µ–π –ø–∞—Ä–∫–æ–≤–∫–µ.\n\n–£–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ –¥–æ–ø.–∫–≤–∞—Ä—Ç–∏—Ä—ã, –∫–ª–∞–¥–æ–≤–∫–∏ –∏ –ø–∞—Ä–∫–æ–≤–∫–∏, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –ª–∏ –£–ö –≤–∞—à–∏–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –ø–æ 1-–º—É –û–°–°.`,
			extra: Extra.HTML().markup(m => m.inlineKeyboard([

				[Markup.callbackButton("–¥–æ–±–∞–≤–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É",	`{"prop":{"type":"apt"}}`)],
				[Markup.callbackButton("–¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∞–¥–æ–≤–∫—É",	`{"prop":{"type":"parking"}}`)],
				[Markup.callbackButton("–¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∫–æ–≤–∫—É",	`{"prop":{"type":"storage"}}`)]
			]))
		}
}


/*<b>–í–æ—Å—Ç–æ—á–Ω–∞—è –±–∞—à–Ω—è</b>
<a href="https://t.me/joinchat/GCYOWEuq2ObEGdOa_0jVeA">—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–∞—Ç</a> - –¥–ª—è –∂–∏–ª—å—Ü–æ–≤ –í–æ—Å—Ç–æ—á–Ω–æ–π –±–∞—à–Ω–∏.
*/



const BOT_MSG_RESOURCES = `<b>–ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏ - –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π</b>
@PresnyaCityOfficial - –æ–±—â–∏–π —á–∞—Ç —Å–æ—Å–µ–¥–µ–π c –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è–º–∏ –£–ö –∏ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞

<b>–ó–∞–∫—Ä—ã—Ç—ã–π —á–∞—Ç</b>
–¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤.
–í—Ö–æ–¥ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ @PresnyaBot

<b>–ö–∞–Ω–∞–ª "–í—Å—ë –ø–æ –î–µ–ª—É"</b>
<a href="https://t.me/presnya_city_news">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª</a> - –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –Ω–µ —Ö–æ—á–µ—Ç —á–∏—Ç–∞—Ç—å —á–∞—Ç—ã, –Ω–æ —Ö–æ—á–µ—Ç –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –∏ –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

<b>–ó–∞–ø–∞–¥–Ω–∞—è –±–∞—à–Ω—è</b>
–û—Ç–¥–µ–ª—å–Ω—ã–π —á–∞—Ç –¥–ª—è –∂–∏–ª—å—Ü–æ–≤ –ó–∞–ø–∞–¥–Ω–æ–π –±–∞—à–Ω–∏. –ù–∞–ø–∏—à–∏—Ç–µ <a href="tg://user?id=779452436">–í–∞–ª–µ–Ω—Ç–∏–Ω–µ</a>, –∞–¥–º–∏–Ω—É —ç—Ç–æ–≥–æ —á–∞—Ç–∞, —á—Ç–æ–±—ã –æ–Ω–∞ –≤–∞—Å –≤ –Ω–µ–≥–æ –¥–æ–±–∞–≤–∏–ª–∞.

<b>–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –±–∞—à–Ω—è</b>
<a href="https://t.me/joinchat/DeM53h1ysuCItx-uvCNxzA">—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–∞—Ç</a> –¥–ª—è –∂–∏–ª—å—Ü–æ–≤ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –±–∞—à–Ω–∏.

<b>–í–æ—Å—Ç–æ—á–Ω–∞—è –±–∞—à–Ω—è</b>
<a href="https://t.me/joinchat/GCYOWEuq2ObEGdOa_0jVeA">—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–∞—Ç</a> - –¥–ª—è –∂–∏–ª—å—Ü–æ–≤ –í–æ—Å—Ç–æ—á–Ω–æ–π –±–∞—à–Ω–∏.

<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º</b>
<a href="https://t.me/joinchat/LnWAFBSF0dErJXZaQNCZUA">—Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</a> - –∑–¥–µ—Å—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏ –¥–µ–ª—è—Ç—Å—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –∏ –∞–Ω—Ç–∏-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º, –±—Ä–∏–≥–∞–¥–∞–º –∏ —Ç.–¥.
–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –≤ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª, –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ <a href="tg://user?id=779452436">–í–∞–ª–µ–Ω—Ç–∏–Ω–µ</a>

<b>–ü–∞—Ä–∫–∏–Ω–≥ –∏ –∫–ª–∞–¥–æ–≤–∫–∏</b>
@Psparking

<b>–õ–∞–π—Ñ—Ö–∞–∫–∏</b>
@PresnyaCityLifehack - –æ—Ç–≤–µ—Ç—ã –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–≤—ã–∑–æ–≤ –ë–¢–ò, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏)

<b>–û—Ç–æ–ø–ª–µ–Ω–∏–µ, –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è</b>
@Kondeiotoplenie

<b>–î–µ—Ç–∏</b>
@PresnyaCity_Kids
‚Äç
<b>–ö–æ—Ç–æ–ø—ë—Å</b>
@Presnyacity_Kotopes

<b>NightOut</b>
@PresnyaCityNightOut

<b>–ü—Ä–æ –µ–¥—É</b>
@PresnyaZhratva

<b>–ë–∞—Ä–∞—Ö–æ–ª–∫–∞</b>
@presnyacitybaraholka - –∫—É–ø–∏—Ç—å/–ø—Ä–æ–¥–∞—Ç—å/–æ–±–º–µ–Ω—è—Ç—å –ª—é–±—É—é –≤–µ—â—å

<b>–Æ—Ä–∏—Å—Ç</b>
–û—Ç–¥–µ–ª—å–Ω—ã–π —á–∞—Ç —Ç–µ—Ö, –∫—Ç–æ —Å–∫–∏–Ω—É–ª—Å—è –Ω–∞ —é—Ä–∏—Å—Ç–∞.
–ï—Å–ª–∏ –≤—ã —Ç–æ–∂–µ —Ö–æ—Ç–∏—Ç–µ —Å–∫–∏–Ω—É—Ç—å—Å—è –Ω–∞ —é—Ä–∏—Å—Ç–∞ - —Ç–æ —ç—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ —á–∞—Ç-–±–æ—Ç–µ @PresnyaBot
`;





const BOT_MSG_VOTE1 = `<b>–û—Å—Ç–∞–ª–æ—Å—å 2 –¥–Ω—è</b>, —á—Ç–æ–±—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ "–ê–∫—Ç–∏–≤–Ω—ã–π –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω" –≤ –ñ–ö –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏. –ë—É–∫–≤–∞–ª—å–Ω–æ —Å–µ–≥–æ–¥–Ω—è –∏ –∑–∞–≤—Ç—Ä–∞.

<b>–ß—Ç–æ —Ç–∞–∫–æ–µ "–ê–∫—Ç–∏–≤–Ω—ã–π –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω"?</b>
–≠—Ç–æ –ø—Ä–æ–µ–∫—Ç –º—ç—Ä–∏–∏ –≥.–ú–æ—Å–∫–≤—ã https://ag.mos.ru - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –≥–æ—Ä–æ–¥—Å–∫–∞—è –ø–ª–æ—â–∞–¥–∫–∞ –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π.
–ï—ë –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –æ–±—â–∏—Ö —Å–æ–±—Ä–∞–Ω–∏–π –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π –∂–∏—Ç–µ–ª–µ–π –Ω–∞—à–µ–≥–æ –¥–æ–º–∞.
–ù–æ –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∞–¥–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ –≤—ã–±–æ—Ä —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –æ–±—â–µ–º —Å–æ–±—Ä–∞–Ω–∏–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ - —Å—Ç–∞—Ä—ã–º –±—É–º–∞–∂–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.

<b>–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?</b>
–í–æ—Ç –ø—Ä–∏–º–µ—Ä:
–í —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ –º—ã –Ω–∞—á–Ω–µ–º –ø–ª–∞—Ç–∏—Ç—å 18 —Ä—É–±–ª–µ–π —Å –∫–≤.–º–µ—Ç—Ä–∞ (800-1600 —Ä—É–±–ª–µ–π —Å –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ –º–µ—Å—è—Ü) –æ—Ç—á–∏—Å–ª–µ–Ω–∏–π –≤ —Ñ–æ–Ω–¥ –∫–∞–ø–∏—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞.
–≠—Ç–æ 21 –º–∏–ª–ª–∏–æ–Ω —Ä—É–±–ª–µ–π –≤ –≥–æ–¥. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, —ç—Ç–∏ –¥–µ–Ω—å–≥–∏ —É–π–¥—É—Ç –Ω–∞ –æ–±—â–∏–π –≥–æ—Ä–æ–¥—Å–∫–æ–π —Å—á–µ—Ç –∏ –Ω–∞ –Ω–∏—Ö –±—É–¥—É—Ç —Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—è—Ç–∏—ç—Ç–∞–∂–∫–∏, –ø–æ–∫–∞ –Ω–∞—à –¥–æ–º –∂–¥–µ—Ç —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏.
–ù–æ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ø–µ—Ü.—Å—á–µ—Ç –Ω–∞—à–µ–≥–æ –¥–æ–º–∞ –∏ –∞–∫–∫—É–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏ –Ω–∞ –Ω—ë–º, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ —É—à–ª–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ –¥–æ–º–∞.
–ò –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∞–¥–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∏ —Å–æ–±—Ä–∞—Ç—å –∫–≤–æ—Ä—É–º (–±–æ–ª–µ–µ –ø–æ–ª–æ–≤–∏–Ω—ã –≥–æ–ª–æ—Å–æ–≤, –∞ –ø–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö 2/3 –≥–æ–ª–æ—Å–æ–≤).
–ö–∞–∫ –ø–æ–∫–∞–∑–∞–ª–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞, <b>–≤ –¥–æ–º–µ –Ω–∞ 1500 –∫–≤–∞—Ä—Ç–∏—Ä –ø—Ä–æ–≤–µ—Å—Ç–∏ "–±—É–º–∞–∂–Ω–æ–µ" –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ - –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ä–µ–∞–ª—å–Ω–æ.</b>
–¢–æ–ª—å–∫–æ –ª–∏—à—å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–æ–±—Ä–∞–Ω–∏—è, –ø–æ –∑–∞–∫–æ–Ω—É, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–∫–∞–∑–Ω—ã–º–∏ –ø–∏—Å—å–º–∞–º–∏ - —ç—Ç–æ –ø–æ—Ä—è–¥–∫–∞ 150 000 —Ä—É–±–ª–µ–π –≤ –Ω–∞—à–µ–º –¥–æ–º–µ.
–ê —Å–±–æ—Ä –∫–≤–æ—Ä—É–º–∞ –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤. –ò –ø–æ –ø—Ä–æ—à–µ—Å—Ç–≤–∏–∏ —ç—Ç–∏—Ö –º–µ—Å—è—Ü–µ–≤, –ú–ñ–ò –º–æ–∂–µ—Ç –ø—Ä–∏–¥—Ä–∞—Ç—å—Å—è –∫ –∑–∞–ø—è—Ç–æ–π –≤ —Ñ–æ—Ä–º–µ –±–ª–∞–Ω–∫–∞ –∏ –Ω–µ –ø—Ä–∏–∑–Ω–∞—Ç—å —Å–æ–±—Ä–∞–Ω–∏–µ (–æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –µ–≥–æ —Ç–µ–º–∞ - —Å–º–µ–Ω–∞ –£–ö).

–¢–∞–∫–∏–º —Å–ø–æ—Å–æ–±–æ–º –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –±—É–¥–µ—Ç —Ä–µ—à–∞—Ç—å—Å—è –æ–æ–æ–æ—á–µ–Ω—å –¥–æ–ª–≥–æ.
–ê –Ω–µ—Ä–µ—à–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —É–∂–µ —Å–µ–π—á–∞—Å –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å –ø—Ä–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –≤ –ª–∏—Ñ—Ç–∞—Ö, –º—ã—Ç—å–µ –æ–∫–æ–Ω —Å –≤–Ω–µ—à–Ω–µ–π —Å—Ç–æ—Ä–æ–Ω—ã, —Å–ª–∏—à–∫–æ–º —Ä–µ–¥–∫–∞—è —É–±–æ—Ä–∫–∞ –≤ –∫–æ—Ä–∏–¥–æ—Ä–∞—Ö, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã–π –±–æ—Ä–¥—é—Ä –Ω–∞ –≤—ä–µ–∑–¥–µ –≤ –ø–∞—Ä–∫–∏–Ω–≥, –º–æ–π–∫–∞ –Ω–∞ -1 —ç—Ç–∞–∂–µ, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Ç–∞–ø–ª–∏–≤–∞–µ—Ç -4 —ç—Ç–∞–∂, –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.
–ê –µ—Å–ª–∏ –≤—Å—Ç–∞–Ω–µ—Ç –≤–æ–ø—Ä–æ—Å –æ —Å–º–µ–Ω–µ –£–ö? - –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ —É—Å–ª–æ–≤–∏—è—Ö –±—É–º–∞–∂–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è, –∫–æ–≥–¥–∞ –±–µ–∑ —É—á–∞—Å—Ç–∏—è –£–ö —Å–ª–æ–∂–Ω–æ –¥–∞–∂–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑–æ—Å–ª–∞—Ç—å?
–í—ã —á—Ç–æ-–Ω–∏–±—É–¥—å —Å–ª—ã—à–∞–ª–∏ –æ—Ç –£–ö –ø—Ä–æ –≤—Ç–æ—Ä–æ–µ —Å–æ–±—Ä–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤? –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –£–ö –Ω–∞–ø–æ–º–∏–Ω–∞–ª–∏ –≤–∞–º –ø—Ä–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ? –ö–æ–Ω–µ—á–Ω–æ –Ω–µ—Ç. –ò–º –æ—á–µ–Ω—å –∏ –æ—á–µ–Ω—å –Ω–µ—É–¥–æ–±–µ–Ω "–ê–∫—Ç–∏–≤–Ω—ã–π –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω".

–ü–æ—Ç–æ–º—É —á—Ç–æ "–ê–∫—Ç–∏–≤–Ω—ã–π –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω" –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ —Å–æ–±—Ä–∞–Ω–∏–µ <b>–∑–∞ 5 –¥–Ω–µ–π</b>, —Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ–º, –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –∏ –±–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –£–ö.
`





const BOT_MSG_VOTE2 = `
<b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å?</b>
–ù–∞–¥–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å <a href="https://assets.website-files.com/5cadb302aac547675d199151/5cdda690ee894cc0d0b03af0_2%D0%BE%D1%81%D1%81.%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5.pdf">—ç—Ç–æ—Ç –±–ª–∞–Ω–∫</a> –∏ –æ—Ç–¥–∞—Ç—å –µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –±–∞—à–Ω–∏.
–î–æ –≤–µ—á–µ—Ä–∞ 21-–≥–æ –∏—é–Ω—è (–ø—è—Ç–Ω–∏—Ü–∞) –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ.

<b>–ï—Å–ª–∏ –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–µ—Ö–∞—Ç—å –≤ –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏ –¥–æ 18:00 –ø—è—Ç–Ω–∏—Ü—ã, 21 –∏—é–Ω—è:</b>
<b>1.</b> –í–æ–∑—å–º–∏—Ç–µ <a href="https://assets.website-files.com/5cadb302aac547675d199151/5cdda690ee894cc0d0b03af0_2%D0%BE%D1%81%D1%81.%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5.pdf">–±–ª–∞–Ω–∫</a> –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –Ω–∞ —Ä–µ—Å–µ–ø—à–µ–Ω –≤–∞—à–µ–π –±–∞—à–Ω–∏. –ë–ª–∞–Ω–∫–æ–≤ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ - <b>–¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä—ã, –∫–ª–∞–¥–æ–≤–∫–∏ –∏ –ø–∞—Ä–∫–æ–≤–∫–∏</b>
<b>2.</b> –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å—ë, —á—Ç–æ —Å–º–æ–∂–µ—Ç–µ. –ß—Ç–æ –Ω–µ –∑–Ω–∞–µ—Ç–µ - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ.
<b>3.</b> –ü—Ä–æ–≥–æ–ª–æ—Å—É–π—Ç–µ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É. –°–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å 9-–≥–æ –ø–æ 14-–π (–ø—Ä–æ —Å–∏—Å—Ç–µ–º—É —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è "–ê–∫—Ç–∏–≤–Ω—ã–π –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω")
<b>4.</b> –û—Ç–¥–∞–π—Ç–µ –±–ª–∞–Ω–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.

<b>–ï—Å–ª–∏ –í—ã –ù–ï —Å–º–æ–∂–µ—Ç–µ –ø—Ä–∏–µ—Ö–∞—Ç—å –≤ –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏:</b>
<b>1.</b> –°–∫–∞—á–∞–π—Ç–µ –±–ª–∞–Ω–∫ <a href="https://assets.website-files.com/5cadb302aac547675d199151/5cdda690ee894cc0d0b03af0_2%D0%BE%D1%81%D1%81.%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5.pdf">–≤–æ—Ç –∑–¥–µ—Å—å</a> –∏ —Ä–∞—Å–ø–µ—á–∞—Ç–∞–π—Ç–µ –µ–≥–æ. –ë–ª–∞–Ω–∫–æ–≤ –º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ - <b>–¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä—ã, –∫–ª–∞–¥–æ–≤–∫–∏ –∏ –ø–∞—Ä–∫–æ–≤–∫–∏</b>
<b>2.</b> –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å—ë, —á—Ç–æ —Å–º–æ–∂–µ—Ç–µ. –ß—Ç–æ –Ω–µ –∑–Ω–∞–µ—Ç–µ - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ.
<b>3.</b> –ü—Ä–æ–≥–æ–ª–æ—Å—É–π—Ç–µ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É. –°–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å 9-–≥–æ –ø–æ 14-–π (–ø—Ä–æ —Å–∏—Å—Ç–µ–º—É —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è "–ê–∫—Ç–∏–≤–Ω—ã–π –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω")
<b>4.</b> –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –±–ª–∞–Ω–∫ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –Ω–∞ –ø–æ—á—Ç—É presnya.golos@gmail.com; –¥–æ—Å—Ç–∞–≤–∫—É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –æ–±—Å—É–¥–∏–º –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ.

–î–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤–∞–∂–Ω—ã –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –º–µ—Ç—Ä—ã! –ü–æ—ç—Ç–æ–º—É –≥–æ–ª–æ—Å—É–π—Ç–µ –≤—Å–µ–º, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –≤ –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏ - <b>–∫–≤–∞—Ä—Ç–∏—Ä–∞–º–∏, –∫–ª–∞–¥–æ–≤–∫–∞–º–∏ –∏ –ø–∞—Ä–∫–æ–≤–∫–∞–º–∏!</b>

<i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ "–ê–∫—Ç–∏–≤–Ω–æ–≥–æ –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞" (–ø.9-14). –ë–µ–∑ —Ö–æ—Ä–æ—à–µ–π —Å–∏—Å—Ç–µ–º—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –º—ã —Å –≤–∞–º–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –Ω–µ —Å–º–æ–∂–µ–º –ø—Ä–∏–Ω—è—Ç—å –Ω–∏–∫–∞–∫–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è, –∏ –£–ö –±—É–¥–µ—Ç —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.</i>
`





const BOT_MSG_WELCOME = `, –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —á–∞—Ç –ñ–ö –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏!
–ù–∞–∂–º–∏—Ç–µ –∑–¥–µ—Å—å: @PresnyaBot, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–≤–æ–∏—Ö —Å–æ—Å–µ–¥–µ–π.

<b>–ö–æ–Ω—Ç–∞–∫—Ç—ã</b> –∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏:
https://presnya.pro/kontakty

<b>–ê—Ä–µ–Ω–¥–∞ –ø–∞—Ä–∫–æ–≤–æ–∫ –∏ –∫–ª–∞–¥–æ–≤–æ–∫</b> –≤ –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏:
https://www.presnya.pro/offers/parking

<b>–ü—Ä–æ–º–æ–∫–æ–¥—ã</b>, —Å–∫–∏–¥–∫–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º –æ—Ç —Å–æ—Å–µ–¥–µ–π:
https://www.presnya.pro/offers/promos
`;





const BOT_OSS_MESSAGE = `<b>28.05 –≤ 18:30 —Å—Ç–∞—Ä—Ç—É–µ—Ç 2-–µ —Å–æ–±—Ä–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤</b>

–£–≤–∞–∂–∞–µ–º—ã–µ —Å–æ—Å–µ–¥–∏!
–ó–∞ 2.5 –º–µ—Å—è—Ü–∞ —Ä–∞–±–æ—Ç—ã –∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤ —Å –£–ö —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1) –°—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–≤–æ–∑–∞ –º—É—Å–æ—Ä–∞ —Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞ 40% - —Å 419 –¥–æ 249 —Ä/–∫–≤.–º
2) –ü—É–Ω–∫—Ç 4.2.6: –ø—Ä–æ –∫–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞ —Ä–µ–º–æ–Ω—Ç–∞ (—Å–æ —à—Ç—Ä–∞—Ñ–∞–º–∏) - —É–¥–∞–ª—ë–Ω –∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞.
3) –ü—É–Ω–∫—Ç 4.2.7: –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å –æ—Ç–¥–∞—Ç—å –≤ –£–ö –∫–æ–º–ø–ª–µ–∫—Ç –∫–ª—é—á–µ–π –æ—Ç —Å–≤–æ–∏—Ö –ø–æ–º–µ—â–µ–Ω–∏–π - —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —É–ø—Ä–∞–∑–¥–Ω–µ–Ω–æ.
4) –ü—É–Ω–∫—Ç 4.2.8: –ø—Ä–∞–≤–æ –£–ö –≤—Ö–æ–¥–∏—Ç—å –≤ –∫–≤–∞—Ä—Ç–∏—Ä—É –±–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –∏ —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –æ–ø–∏—Å—å –∏–º—É—â–µ—Å—Ç–≤–∞ - —ç—Ç–æ –ø—Ä–∞–≤–æ —É–ø—Ä–∞–∑–¥–Ω–µ–Ω–æ.
5) –ü—É–Ω–∫—Ç 2.12: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∞–≤–æ –£–ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å –Ω–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –≤–æ –≤—Å–µ—Ö —Å—É–¥–µ–±–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Ü–∏—è—Ö - —ç—Ç–æ –ø—Ä–∞–≤–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ —Å–ø–∏—Å–∫–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–µ–º.
6) –ü—É–Ω–∫—Ç 2.3: –ø—Ä–∞–≤–æ –£–ö —Ä–∞–∑–º–µ—â–∞—Ç—å –≤ –Ω–∞—à–µ–º –¥–æ–º–µ —Ä–µ–∫–ª–∞–º—É –Ω–∞ —Å–≤–æ—ë —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞—Ç—å —Å —ç—Ç–æ–≥–æ –¥–æ—Ö–æ–¥ - —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ —Ä–µ—à–µ–Ω–∏—é –æ–±—â–µ–≥–æ —Å–æ–±—Ä–∞–Ω–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤
7) –ü—É–Ω–∫—Ç 2.4: –ø—Ä–∞–≤–æ –£–ö –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –Ω–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ª—é–±—ã–º —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏—è - —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—á–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞, –∫—Ä–æ–º–µ –æ–≥–æ–≤–æ—Ä–µ–Ω–Ω—ã—Ö –≤ –¥–æ–≥–æ–≤–æ—Ä–µ —Å–ª—É—á–∞–µ–≤.

–ó–∞ –Ω–æ–≤—É—é —Ä–µ–¥–∞–∫—Ü–∏—é –Ω–∞–¥–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –Ω–∞ –æ–±—â–µ–º —Å–æ–±—Ä–∞–Ω–∏–∏ <b>28-–≥–æ –º–∞—è (–∑–∞–≤—Ç—Ä–∞)</b> - –í–æ–ø—Ä–æ—Å ‚Ññ8 –≤ <a href="https://assets.website-files.com/5cadb302aac547675d199151/5cdda690ee894cc0d0b03af0_2%D0%BE%D1%81%D1%81.%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5.pdf">–±–ª–∞–Ω–∫–µ —Ä–µ—à–µ–Ω–∏–π</a>.

<b>–≠–¢–û –û–ß–ï–ù–¨ –í–ê–ñ–ù–û –°–î–ï–õ–ê–¢–¨.</b>

–ï—Å–ª–∏, –∫–æ–Ω–µ—á–Ω–æ, –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞—Ç—å—Å—è —Å–æ —Å—Ç–∞—Ä—ã–º –¥–æ–≥–æ–≤–æ—Ä–æ–º, —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–º –∏ –∑–∞–≤—ã—à–µ–Ω–Ω–æ–π –ø–æ—á—Ç–∏ –≤–¥–≤–æ–µ —Ü–µ–Ω–æ–π –∑–∞ –º—É—Å–æ—Ä.
<b>–í—Ä–µ–º—è: 28 –º–∞—è (–≤—Ç–æ—Ä–Ω–∏–∫), —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ 18:30, –Ω–∞—á–∞–ª–æ –≤ 19:00.
–ê–¥—Ä–µ—Å: –≥. –ú–æ—Å–∫–≤–∞, –ú–∞–ª—ã–π –ö–æ–Ω—é—à–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä., –¥.2, 1-–π —ç—Ç–∞–∂.</b>
–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ —Å–æ–±—Ä–∞–Ω–∏—é: https://presnya.pro/oss2

–í–æ–æ–±—â–µ, –≤—Å—ë –≤—Ç–æ—Ä–æ–µ —Å–æ–±—Ä–∞–Ω–∏–µ –ø–æ—Å–≤—è—â–µ–Ω–æ –æ–¥–Ω–æ–π –±–æ–ª—å—à–æ–π —Ç–µ–º–µ: –∫–∞–∫ –æ–±—É–∑–¥–∞—Ç—å –£–ö –∏ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏ –¥–æ–º–∞ –Ω–µ –æ–∫–∞–∑–∞–ª–∏—Å—å –º–æ–ª—á–∞–ª–∏–≤—ã–º–∏ –∑–∞–ª–æ–∂–Ω–∏–∫–∞–º–∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤, –Ω–∞–≤—è–∑–∞–Ω–Ω—ã—Ö –ü–ò–ö-–ö–æ–º—Ñ–æ—Ä—Ç–æ–º.
–ò–∑ –æ–±—â–µ–Ω–∏—è —Å —é—Ä–∏—Å—Ç–æ–º –º—ã –≤—ã–Ω–µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –¥–æ–º—É –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –£–ö:
1) –°–æ–≤–µ—Ç –¥–æ–º–∞
2) –ê–∫—Ç–∏–≤–Ω—ã–π –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω (—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ –≥–æ—Ä–æ–¥–∞, –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ö–æ–¥–∏—Ç—å –Ω–∞ –ø–æ–∫–ª–æ–Ω –≤ –£–ö)
3) –û–ø–ª–∞—Ç–∞ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö —É—Å–ª—É–≥ —á–µ—Ä–µ–∑ –≥–æ—Ä–æ–¥—Å–∫–æ–π –ú–§–¶, –∞ –Ω–µ —á–∞—Å—Ç–Ω—É—é –ª–∞–≤–æ—á–∫—É –Ω–∞ —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –£–ö
4) –ò —Å–∞–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä - —ç—Ç–æ —Ç–æ–∂–µ –≤–∞–∂–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –£–ö

–ï—Å–ª–∏ –í—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –ø—Ä–∏–¥—Ç–∏ –Ω–∞ —Å–æ–±—Ä–∞–Ω–∏–µ 28-–≥–æ –º–∞—è, —Ç–æ –ø—Ä–æ–≥–æ–ª–æ—Å—É–π—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–æ—á–Ω–æ –¥–æ 21-–≥–æ –∏—é–Ω—è. –î–ª—è —ç—Ç–æ–≥–æ:
1. –í–æ–∑—å–º–∏—Ç–µ –±–ª–∞–Ω–∫ —Ä–µ—à–µ–Ω–∏—è –∏–∑ –ø–∏—Å—å–º–∞-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–ª–∏ <a href="https://assets.website-files.com/5cadb302aac547675d199151/5cdda690ee894cc0d0b03af0_2%D0%BE%D1%81%D1%81.%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5.pdf">—Å–∫–∞—á–∞–π—Ç–µ</a> –µ–≥–æ —Å —Å–∞–π—Ç–∞ https://www.presnya.pro/oss2
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –±–ª–∞–Ω–∫ (–≤ —è—á–µ–π–∫–∞—Ö –¥–ª—è –≥–æ–ª–æ—Å–∞ –ª—É—á—à–µ —Å—Ç–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å, –∞ –Ω–µ –∫—Ä–µ—Å—Ç–∏–∫ –∏–ª–∏ –≥–∞–ª–æ—á–∫—É - —á—Ç–æ–±—ã –≤–∞—à –±–ª–∞–Ω–∫ –±—ã–ª–æ —Å–ª–æ–∂–Ω–æ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å)
3. <b>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –±–ª–∞–Ω–∫ –Ω–∞ —Å–≤–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω!</b> –ü—É—Å—Ç—å —É –≤–∞—Å –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∫–æ–ø–∏—è –¥–ª—è –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏.
4. –û—Ç–¥–∞–π—Ç–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –±–ª–∞–Ω–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤–∞—à–µ–π –±–∞—à–Ω–∏. –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –µ–≥–æ —Å–¥–µ–ª–∞—Ç—å –∫–æ–ø–∏—é –∏ —Ä–∞—Å–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–µ–π –∑–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ –≥–æ–ª–æ—Å–∞.
5. –ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–æ—Ç–æ –≤–∞—à–µ–≥–æ –±–ª–∞–Ω–∫–∞ –Ω–∞ –ø–æ—á—Ç—É: <b>presnya.golos@gmail.com</b> - —á—Ç–æ–±—ã –±—ã–ª–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –£–ö –ø–æ —Å–±–æ—Ä—É –≥–æ–ª–æ—Å–æ–≤.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –Ω–æ–≤–æ–π —Ä–µ–¥–∞–∫—Ü–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞: https://presnya.pro/dogovor-upravleniya
–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –≤—Ç–æ—Ä–æ–º—É —Å–æ–±—Ä–∞–Ω–∏—é: https://www.presnya.pro/oss2
–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–º—É —á–∞—Ç—É: /lawyer
`




const BOT_OSS_MESSAGE_OLD = `–£–≤–∞–∂–∞–µ–º—ã–µ —Å–æ—Å–µ–¥–∏!
–ü–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É –ø–µ—Ä–≤–æ–µ –æ–±—â–µ–µ —Å–æ–±—Ä–∞–Ω–∏–µ –∂–∏–ª—å—Ü–æ–≤ - 31-–µ –º–∞—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.
–ß—Ç–æ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å—Å—è –ø–æ—Å–ª–µ 31-–≥–æ –º–∞—è, –∫–æ–≥–¥–∞ –£–ö –ø–æ—á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è –ø–æ–ª–Ω–æ–≤–ª–∞—Å—Ç–Ω—ã–º —Ö–æ–∑—è–∏–Ω–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏—è, —Å–ª–æ–∂–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å.
–î–∞–∂–µ —Å–µ–π—á–∞—Å, –µ—â–µ –¥–æ –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤, –æ–Ω–∏ –Ω–µ —Å—Ç–µ—Å–Ω—è—é—Ç—Å—è —Ö–æ–¥–∏—Ç—å –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–∞–º –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤, –≤—ã–∫–ª–∞–¥—ã–≤–∞—Ç—å —ç—Ç–∏ —Ñ–æ—Ç–æ –≤ –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Ä–µ–º–æ–Ω—Ç, –Ω–µ–∑–∞–∫–æ–Ω–Ω–æ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –∫—É–ø–∏—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –°–†–û-–ø—Ä–æ–µ–∫—Ç–æ–≤ —É –Ω–µ–∫–æ–≥–æ –û–û–û "–ú–∞—è–∫" (–∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –∏–º–µ–µ—Ç —á–ª–µ–Ω—Å—Ç–≤–∞ –≤ –°–†–û –∏ –¥–æ–ª–∂–Ω–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏), –≤–µ—Å—Ç–∏ —Å–µ–±—è –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ —Ö–∞–º—Å–∫–∏, –Ω–∞–∑—ã–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ "–≤–æ—Ä–∞–º–∏" –∏ –≤—Å—ë —ç—Ç–æ –Ω–∞ —Ñ–æ–Ω–µ –ø–æ–ª–Ω–µ–π—à–µ–≥–æ –ø—Ä–µ–Ω–µ–±—Ä–µ–∂–µ–Ω–∏—è –∫ —Å–≤–æ–∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—è–º: –ú–û–ü-—ã –Ω–µ —É–±–∏—Ä–∞—é—Ç—Å—è, –Ω–∞ –∫—Ä—ã—à—É —Ç–æ–ª–ø–∞–º–∏ —Ö–æ–¥—è—Ç –º–∞–ª–æ–ª–µ—Ç–∫–∏-—Ä—É—Ñ–µ—Ä—ã, –¥–≤–µ—Ä–∏ –æ–±–∫–ª–µ—è–Ω—ã —Ä–µ–∫–ª–∞–º–æ–π, –æ—Ö—Ä–∞–Ω–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–∞ —Å–≤–æ–∏—Ö –º–µ—Å—Ç–∞—Ö –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–∞–µ—Ç, –ª–∏—Ñ—Ç—ã –Ω–µ —Ä–∞–±—Ç–∞—é—Ç –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.

–ö–æ–Ω–µ—á–Ω–æ, –º—ã –Ω–µ –ø—Ä–∏–∑—ã–≤–∞–µ–º –∫ —Ä–µ–≤–æ–ª—é—Ü–∏–∏ –∏ —Å–º–µ–Ω–µ –£–ö.
–ù–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–º–∞–Ω–¥—É –£–ö –±–µ–∑ –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ –Ω–∞–¥–∑–æ—Ä–∞, –±–µ–∑ —Ä–∞–º–æ–∫ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏—Ö –≤–ª–∞—Å—Ç–∏ - –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–∞—à–Ω–æ.

–ü–æ—ç—Ç–æ–º—É —Ä—è–¥ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤, –Ω–µ—Å–æ–≥–ª–∞—Å–Ω—ã—Ö —Å —Ç–∞–∫–∏–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º –£–ö, –Ω–æ —Å—á–∏—Ç–∞—é—â–∏—Ö, —á—Ç–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π, –º–∏—Ä–Ω—ã–π –∏ –∑–∞–∫–æ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ —ç—Ç–æ–≥–æ –∏–¥–∏–æ—Ç–∏–∑–º–∞ –≤—Å—ë –∂–µ –µ—Å—Ç—å, –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç –≤–≤–µ—Å—Ç–∏ 4 –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –£–ö:
<b>1) –ù–æ–≤—ã–π –¥–æ–≥–æ–≤–æ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</b>
<b>2) –°–æ–≤–µ—Ç –¥–æ–º–∞</b>
<b>3) –ê–∫—Ç–∏–≤–Ω—ã–π –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω</b> - —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ä–æ–¥–∞ –ú–æ—Å–∫–≤—ã –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤.
<b>4) –ú–æ—Å–∫–æ–≤—Å–∫–∏–π –ú–§–¶</b> –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–∞—Å—á–µ—Ç–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ (–¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é –æ—Ç –£–ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é).

–ß—Ç–æ–±—ã —ç—Ç–∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏, –∑–∞ –Ω–∏—Ö –Ω–∞–¥–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –Ω–∞ –≤—Ç–æ—Ä–æ–º —Å–æ–±—Ä–∞–Ω–∏–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ (28.05 - 21.06).
–û–Ω–∏ –Ω—É–∂–Ω—ã, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ç–∏–≤–æ–≤–µ—Å –±–µ–∑–≥—Ä–∞–Ω–∏—á–Ω–æ–π –≤–ª–∞—Å—Ç–∏ –£–ö –≤ –Ω–∞—à–µ–º –¥–æ–º–µ.
–ë–µ–∑ —Ç–∞–∫–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –±—É–¥–µ—Ç –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ –¥–æ–±–∏—Ç—å—Å—è –æ—Ç –£–ö —Ä–µ—à–µ–Ω–∏—è –∫–∞–∫–∏—Ö-–ª–∏–±–æ –ø—Ä–æ–±–ª–µ–º –¥–æ–º–∞, –≤–µ–¥—å –µ–¥–∏–Ω–∏—á–Ω—ã–µ –∂–∞–ª–æ–±—ã —ç—Ç–∏—Ö –æ–ø—ã—Ç–Ω—ã—Ö —Ä–µ–±—è—Ç –Ω–µ –ø—É–≥–∞—é—Ç.
–ù—É–∂–Ω–æ –≤—Å–ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ –ü—Ä–µ—Å–Ω–µ–π –°–∏—Ç–∏ –≤–ª–∞–¥–µ–µ–º –º—ã, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏, –∞ –Ω–µ –ì—Ä–∏—à–∏–Ω —Å –ó–æ—Ç–æ–≤—ã–º. –ù—É–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –£–ö –Ω–∞ –∑–µ–º–ª—é. 

–ü—Ä–æ—à—É –í–∞—Å, –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ <b>28-–≥–æ –º–∞—è (–≤—Ç–æ—Ä–Ω–∏–∫) –≤ 18:30</b> –Ω–∞ –æ—á–Ω—É—é —á–∞—Å—Ç—å –û–±—â–µ–≥–æ –°–æ–±—Ä–∞–Ω–∏—è –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ (–∞–¥—Ä–µ—Å: –≥. –ú–æ—Å–∫–≤–∞, –ú–∞–ª—ã–π –ö–æ–Ω—é—à–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä., –¥.2, 1-–π —ç—Ç–∞–∂).
–ï—Å–ª–∏ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –æ—á–Ω–æ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏, —Ç–æ –ø—Ä–æ–≥–æ–ª–æ—Å—É–π—Ç–µ –∑–∞–æ—á–Ω–æ. –î–ª—è —ç—Ç–æ–≥–æ:
1. –≤–æ–∑—å–º–∏—Ç–µ –±–ª–∞–Ω–∫ —Ä–µ—à–µ–Ω–∏—è –∏–∑ –ø–∏—Å—å–º–∞-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ –µ–≥–æ –∑–¥–µ—Å—å: https://www.presnya.pro/oss2
2. –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –±–ª–∞–Ω–∫ (–≤ —è—á–µ–π–∫–∞—Ö –¥–ª—è –≥–æ–ª–æ—Å–∞ –ª—É—á—à–µ —Å—Ç–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å, –∞ –Ω–µ –∫—Ä–µ—Å—Ç–∏–∫ –∏–ª–∏ –≥–∞–ª–æ—á–∫—É - —á—Ç–æ–±—ã –≤–∞—à –±–ª–∞–Ω–∫ –±—ã–ª–æ —Å–ª–æ–∂–Ω–æ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å)
3. –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –±–ª–∞–Ω–∫ –Ω–∞ —Å–≤–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω! –ü—É—Å—Ç—å —É –≤–∞—Å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∫–æ–ø–∏—è –¥–ª—è –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏
4. –æ—Ç–¥–∞–π—Ç–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –±–ª–∞–Ω–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤–∞—à–µ–π –±–∞—à–Ω–∏
5. –ø—Ä–∏—à–ª–∏—Ç–µ —Ñ–æ—Ç–æ–∫–ø–∏—é –±–ª–∞–Ω–∫–∞ –Ω–∞ –ø–æ—á—Ç—É: fedor.pavlov@gmail.com - —á—Ç–æ–±—ã –±—ã–ª–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –£–ö –ø–æ —Å–±–æ—Ä—É –≥–æ–ª–æ—Å–æ–≤

–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –Ω–æ–≤–æ–π —Ä–µ–¥–∞–∫—Ü–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞: https://presnya.pro/dogovor-upravleniya
–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –≤—Ç–æ—Ä–æ–º—É —Å–æ–±—Ä–∞–Ω–∏—é: https://www.presnya.pro/oss2
–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–º—É —á–∞—Ç—É (–∫–æ—Ç–æ—Ä—ã–π –≤—Å—ë —ç—Ç–æ —Å–¥–µ–ª–∞–ª): /lawyer
`




/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////// –ú–µ–Ω—é

const BOT_MENU = `
/stack - —Å–æ—Å–µ–¥–∏ –≤ —Ç–æ–º –∂–µ —Å—Ç–æ—è–∫–µ (–Ω–∞–¥ –∏ –ø–æ–¥ –≤–∞–º–∏)
/floor - —Å–æ—Å–µ–¥–∏ –ø–æ —ç—Ç–∞–∂—É
/tower - —Å–æ—Å–µ–¥–∏ –≤ –≤–∞—à–µ–π –±–∞—à–Ω–µ
/menu  - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞`;





const BOT_WHATS_NEXT = `<b>–ß—Ç–æ –¥–∞–ª—å—à–µ?</b>
–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞–∂–º–∏—Ç–µ –∑–¥–µ—Å—å: /confirm
–ù–∞–∂–º–∏—Ç–µ /menu, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–∫–æ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –±–æ—Ç–∞`;





const BOT_MSG_HOWOT_CONFIRM = `–ß—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –ñ–ö –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Ñ–æ—Ç–æ –î–î–£ –∏–ª–∏ –î–ö–ü –∏–ª–∏ –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –ï–ì–†–ù (—Å–æ —à—Ç–∞–º–ø–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞; —Å–∫–∞–Ω –∏–ª–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç –î–î–£/–î–ö–ü –Ω–µ –≥–æ–¥–∏—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –Ω–∞ —Å–∫–∞–Ω–µ –Ω–µ—Ç —à—Ç–∞–º–ø–∞) –ø–ª—é—Å –¥–æ–∫—É–º–µ–Ω—Ç, —É–¥–æ—Å—Ç–æ–≤–µ—Ä—è—é—â–∏–π –ª–∏—á–Ω–æ—Å—Ç—å —Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —É–∫–∞–∑–∞–Ω –≤ –î–î–£. –ì–æ–¥–∏—Ç—Å—è –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ, –ø–µ–Ω—Å–∏–æ–Ω–Ω–æ–µ, –°–ù–ò–õ–°, —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –∞–¥–≤–æ–∫–∞—Ç–∞ –∏–ª–∏ –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∞, –∑–∞–≥—Ä–∞–Ω –∏–ª–∏ —Ç–æ–ª—å–∫–æ –≤ –ö–†–ê–ô–ù–ï–ú —Å–ª—É—á–∞–µ –ø–∞—Å–ø–æ—Ä—Ç.

–í–ê–ñ–ù–û: –ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ (–¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, —Ñ–æ—Ç–æ –∏ —Ç.–¥.) –ù–£–ñ–ù–û –∑–∞–∫—Ä—ã—Ç—å –∏–ª–∏ –∑–∞–º–∞–∑–∞—Ç—å, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ, —á—Ç–æ –º–Ω–µ –Ω—É–∂–Ω–æ - —ç—Ç–æ –≤–∞—à–∏ –ø–µ—Ä—Å.–¥–∞–Ω–Ω—ã–µ. –ï—Å–ª–∏ –≤—ã –ø—Ä–∏—à–ª–µ—Ç–µ –±–æ—Ç—É –ø–µ—Ä—Å.–¥–∞–Ω–Ω—ã–µ, —ç—Ç–æ –Ω–∏–∫–∞–∫ –Ω–µ –ø–æ–º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∏—Ç—å –≤–∞—Å –æ—Ç –∞–≥–µ–Ω—Ç–∞: –≤–µ–¥—å –≤—Å–µ –∞–≥–µ–Ω—Ç—ã –∏–∑ –æ—Ñ–∏—Å–∞ –ø—Ä–æ–¥–∞–∂ –∏–º–µ—é—Ç –Ω–∞ —Ä—É–∫–∞—Ö –Ω–∞—à–∏ —Å –≤–∞–º–∏ –ø–µ—Ä—Å.–¥–∞–Ω–Ω—ã–µ, –∏ –∏–º –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ç–æ–∏—Ç –ø—Ä–∏—Å–ª–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ —Å—é–¥–∞.

–ù—É–∂–Ω–∞ –∏–º–µ–Ω–Ω–æ —Ñ–æ—Ç–æ–≥–æ—Ä–∞—Ñ–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –≤–∏–¥–Ω–æ, —á—Ç–æ –≤—ã –≤–ª–∞–¥–µ–µ—Ç–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º - –∏–¥–µ–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ñ–æ—Ç–æ –±—É–¥–µ—Ç —Å —Ä—É–∫–æ–π(–ø–∞–ª—å—Ü–µ–º) –≤ –∫–∞–¥—Ä–µ, –∏ —Å–¥–µ–ª–∞–Ω–æ –Ω–∞ —Ñ–æ–Ω–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –î–î–£/–î–ö–ü/–í—ã–ø–∏—Å–∫–∏. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —ç–∫—Ä–∞–Ω–∞ —Å —Ñ–∞–π–ª–æ–º –∏–ª–∏ –∫—Å–µ—Ä–æ–∫–æ–ø–∏—è - –Ω–µ –≥–æ–¥—è—Ç—Å—è.

–ö–∞–∫ —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã, –≤–∞–º –ø—Ä–∏–¥–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è. –û–±—ã—á–Ω–æ, —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Å–æ–≤.

–£—Å–ø–µ—Ö–æ–≤!`;





const BOT_MSG_NEED_REGISTRATION_PUBLIC = "–∞ –í—ã –ø–æ–∫–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —à–∞—Ö–º–∞—Ç–∫–µ. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –º–Ω–µ –≤ –ª–∏—á–∫—É –Ω–æ–º–µ—Ä –≤–∞—à–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã.\n@PresnyaBot";
const BOT_MSG_NEED_REGISTRATION = `–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω—É–∂–Ω–∞ —Ä–µ–≥–∏—Å—Ç–∞—Ü–∏—è –≤ —à–∞—Ö–º–∞—Ç–∫–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –Ω–æ–º–µ—Ä –≤–∞—à–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã, –∏ —è –í–∞—Å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é.`;





const BOT_MSG_NEED_CONFIRMATION_PUBLIC = "–ú–æ–≥—É –æ—à–∏–±–∞—Ç—å—Å—è, –Ω–æ —É –í–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –ù–æ–≤–æ—Å—Ç–∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ —Å–æ—Å–µ–¥—Å–∫–æ–≥–æ —á–∞—Ç–∞, –ø–æ—ç—Ç–æ–º—É —Ç–∞–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ. –ü—Ä–∏—à–ª–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ñ–æ—Ç–æ –î–î–£ –º–Ω–µ –≤ –ª–∏—á–∫—É (–≤ –æ–±—â–∏–π —á–∞—Ç –∫–∏–¥–∞—Ç—å –Ω–µ –Ω–∞–¥–æ).\n@PresnyaBot";
const BOT_MSG_NEED_CONFIRMATION = `–≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤.
–ù–æ–≤–æ—Å—Ç–∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–∫—Å—Ç—ã –∏ —Ñ–æ—Ç–æ –∏–∑ –∑–∞–∫—Ä—ã—Ç–æ–≥–æ —á–∞—Ç–∞ —Å–∞–º—ã—Ö –Ω–∞—Å—Ç–æ—è—â–∏—Ö —Å–æ—Å–µ–¥–µ–π, –ø–æ—ç—Ç–æ–º—É –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞.
–ï—Å–ª–∏ –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ —à–∞—Ö–º–∞—Ç–∫–µ, —Ç–æ –≤–∞–º –æ—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏—Å–ª–∞—Ç—å –º–Ω–µ —Ñ–æ—Ç–æ –î–î–£ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –≤–∞—à–∏–º –∏–º–µ–Ω–µ–º (–≥–æ–¥–∏—Ç—Å—è –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ, –∑–∞–≥—Ä–∞–Ω –∏–ª–∏ –ø–∞—Å–ø–æ—Ä—Ç; –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, –Ω–∞–¥–æ –∑–∞–º–∞–∑–∞—Ç—å –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç—å).
–ï—Å–ª–∏ –í—ã –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å, —Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ –Ω–æ–º–µ—Ä –≤–∞—à–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã.`;





const BOT_MSG_LAWYER_NEEDS_CONFIRMATION = `–†–∞–±–æ—Ç–∞ —Å —é—Ä–∏—Å—Ç–æ–º –∏ –¥–æ—Å—Ç—É–ø –≤ —Å–æ–æ—Ç–≤–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç –≤–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–≤—à–∏—Ö—Å—è —Å–æ—Å–µ–¥–µ–π.
–ï—Å–ª–∏ –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ —à–∞—Ö–º–∞—Ç–∫–µ, —Ç–æ –≤–∞–º –æ—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏—Å–ª–∞—Ç—å –º–Ω–µ —Ñ–æ—Ç–æ –î–î–£ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –≤–∞—à–∏–º –∏–º–µ–Ω–µ–º (–≥–æ–¥–∏—Ç—Å—è –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ, –∑–∞–≥—Ä–∞–Ω –∏–ª–∏ –ø–∞—Å–ø–æ—Ä—Ç; –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, –Ω–∞–¥–æ –∑–∞–º–∞–∑–∞—Ç—å –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç—å).
–ï—Å–ª–∏ –í—ã –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å, —Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ –Ω–æ–º–µ—Ä –≤–∞—à–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã.`;





const BOT_MSG_LAWYER_WAITING_FOR_PAYMENT = `<b>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π —á–∞—Ç</b>
–°–æ–≤–º–µ—Å—Ç–Ω—ã–º–∏ —É—Å–∏–ª–∏—è–º–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ —á–∞—Ç–∞, (–æ–±—ä–µ–¥–∏–Ω–∏–≤—à–µ–≥–æ 100 —á–µ–ª–æ–≤–µ–∫), –æ–ø–ª–∞—á–µ–Ω –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —é—Ä–∏—Å—Ç –∏ –¥—Ä—É–≥–∏–µ —Ä–∞—Å—Ö–æ–¥—ã, –≤–∫–ª—é—á–∞—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç –ñ–ö –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏ www.presnya.pro

<b>–ü–µ—Ä–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</b>
1. –°–æ–≤–º–µ—Å—Ç–Ω–æ —Å –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è–º–∏ –£–ö —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞
2. –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–∂–µ–Ω—ã —Ç–∞—Ä–∏—Ñ—ã –Ω–∞ –≤—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞ 
3. –ó–∞–ø—É—â–µ–Ω–æ 2 –û–°–°
4. –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏ —Å–Ω–∏–∂–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤ –°–†–û

<b>–í–æ–ø—Ä–æ—Å—ã –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏:</b>
- –ø–µ—Ä–µ—Ä–∞—Å—á–µ—Ç–∞ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π (–æ—Ö—Ä–∞–Ω–∞, —É–±–æ—Ä–∫–∞, –ª–∏—Ñ—Ç—ã)
- —É—Å–∏–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω—ã
- —Ä–∞–±–æ—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –¥—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

<b>–û —Ä–∞–∑–º–µ—Ä–µ –≤–∑–Ω–æ—Å–∞:</b>
–ö–∞–∂–¥–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É –±–æ—Ç –≤—ã–±–µ—Ä–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Å—É–º–º—É –≤–∑–Ω–æ—Å–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –æ—Ç 997 –¥–æ 1003 —Ä—É–±–ª–µ–π. –≠—Ç–∞ —Å—É–º–º–∞ —É–Ω–∏–∫–∞–ª—å–Ω–∞, –æ–Ω–∞ —Å–≤—è–∑–∞–Ω–∞ –∏–º–µ–Ω–Ω–æ —Å –í–∞–º–∏ –∏ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —Å—Ä–µ–¥–∏ –¥—Ä—É–≥–∏—Ö —Å–æ—Å–µ–¥–µ–π. –ö–æ–≥–¥–∞ –¥–µ–Ω—å–≥–∏ –ø–æ—Å—Ç—É–ø—è—Ç –Ω–∞ –∫–∞—Ä—Ç—É, –±–æ—Ç —Å–º–æ–∂–µ—Ç —É–∑–Ω–∞—Ç—å –í–∞—Å –ø–æ —Å—É–º–º–µ –≤–∑–Ω–æ—Å–∞ –∏ –í–∞—Å –¥–æ–±–∞–≤—è—Ç –≤ –∑–∞–∫—Ä—ã—Ç—ã–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π —á–∞—Ç.

<b>–ö–∞–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è:</b>
–°–¥–µ–ª–∞–π—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –æ–¥–Ω—É –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –Ω–∏–∂–µ –∫–∞—Ä—Ç.
–í–∞—Å –¥–æ–±–∞–≤—è—Ç –ø–æ—Å–ª–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –∫–∞—Ä—Ç—É.
–í—ã–±–∏—Ä–∞–π—Ç–µ –ª—é–±—É—é:
–°–±–µ—Ä: <b>4276 3801 1093 3277</b> (<a href="tg://user?id=183673345">–ö–∏—Ä–∏–ª–ª</a>)
–°–±–µ—Ä: <b>4276 3801 7668 6751</b> (<a href="tg://user?id=435715065">–ñ–∞–Ω–Ω–∞</a>)`;





const BOT_MSG_NOTHINGNEW_NEWS_PUBLIC = '–ê –≤—ã —É–∂–µ –≤—Å—ë –ø—Ä–æ—á–∏—Ç–∞–ª–∏, –∏ –Ω–∏—á–µ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–æ–∫–∞ –Ω–µ –ø–æ—è–≤–∏–ª–æ—Å—å';
const BOT_MSG_NOTHINGNEW_NEWS_PRIVATE = `–ü–æ–∫–∞ –Ω–∏–∫–∞–∫–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç.
–ñ–¥–µ–º-—Å...

–ê —Ç–µ–º –≤—Ä–µ–º–µ–Ω–µ–º, –í—ã —Ç–æ–∂–µ –º–æ–∂–µ—Ç–µ –¥–µ–ª–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏!
–ù–∞–π–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ, –ø–æ –≤–∞—à–µ–º—É –º–Ω–µ–Ω–∏—é, –Ω–µ—Å–µ—Ç –≤ —Å–µ–±–µ –ø–æ–ª–µ–∑–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç. –ò –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –Ω–µ–≥–æ (—Å–¥–µ–ª–∞–π—Ç–µ reply) —Å–∏–º–≤–æ–ª–æ–º '+', –∏–ª–∏ 'üëç', –∏–ª–∏ —Ö—ç—à—Ç–µ–≥–æ–º #–≤–Ω–æ–≤–æ—Å—Ç–∏.
–ë–æ—Ç —É–≤–∏–¥–∏—Ç —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ. –ö–æ–≥–¥–∞ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –í—ã –∑–∞–ø—Ä–æ—Å–∏—Ç–µ /news, –±–æ—Ç –ø–æ–∫–∞–∂–µ—Ç –≤–∞–º –≤—Å–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≤—Å–µ—Ö —á–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç @PresnyaBot`;





const BOT_MSG_NOTHINGNEW_NEWS_ZOTOV_PUBLIC = '–ê –≤—ã —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–ª–∏ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–∞, –∏ –±–æ–ª–µ–µ —Å–≤–µ–∂–∏—Ö –ø–æ–∫–∞ –Ω–µ –ø–æ—Å—Ç—É–ø–∞–ª–æ.';
const BOT_MSG_NOTHINGNEW_NEWS_ZOTOV_PRIVATE = '–ù–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ –ø–æ—Å—Ç—É–ø–∞–ª–æ. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä—è–º–æ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–∞, –Ω–∞–∂–º–∏—Ç–µ –≤–æ—Ç –Ω–∞ —ç—Ç—É —Å—Å—ã–ª–∫—É: /konstantin_all';





const BOT_MSG_NOTHINGNEW_NEWS_NICKY_PUBLIC = '–ê –≤—ã —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–ª–∏ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ù–∏–∫–æ–ª–∞—è, –∏ –±–æ–ª–µ–µ —Å–≤–µ–∂–∏—Ö –ø–æ–∫–∞ –Ω–µ –ø–æ—Å—Ç—É–ø–∞–ª–æ.';
const BOT_MSG_NOTHINGNEW_NEWS_NICKY_PRIVATE = '–ù–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ –ø–æ—Å—Ç—É–ø–∞–ª–æ. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä—è–º–æ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ù–∏–∫–æ–ª–∞—è, –Ω–∞–∂–º–∏—Ç–µ –≤–æ—Ç –Ω–∞ —ç—Ç—É —Å—Å—ã–ª–∫—É: /nikolay_all';

	



////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////// MODULE EXPORTS ///////////////////////////////////////////////////////////////////////////////////

module.exports.install = function(bot) {

    bot.use		(mw_upgarde_ctx);
	bot.use		(mw_spam_filter);
    bot.use     (mw_logger);
    bot.use     (answer_callback);
	bot.use     (user_session({logger: trace.info, support: support}, bot.context))
    bot.use     (mw_valid_user_only);
    bot.use     (session())
	bot.use		(if_public(mw_archive));
	bot.use		(mw_kick_kbk);
	bot.use     (stage.middleware());

	
    bot.hashtag	(['#–Ω–∞—Å–∞–π—Ç', '#–≤–Ω–æ–≤–æ—Å—Ç–∏'],	(get_mw_collector('news_chat')));
    bot.hashtag	(['#–≤–æ–ø—Ä–æ—Å', '?'],			if_public(get_mw_collector('news_zotov')));
    bot.action	('/lawyer',					get_safe_mw(mw_money_offer, BOT_MSG_LAWYER_NEEDS_CONFIRMATION));
    bot.command	('/lawyer',					get_safe_mw(mw_money_offer, BOT_MSG_LAWYER_NEEDS_CONFIRMATION));
    bot.command	('/this',					this_chat);
    bot.command	('/cash', 					mw_money_cash);
    bot.command	('/news',					if_public((ctx) => ctx.deleteMessage()));
    bot.command	('/stack',					if_public((ctx) => {

        return ctx.db.query(`select count(*) as cnt from archive where sender.id=${ctx.user.id}`).then(result => {

            ctx.user.stack = `${(ctx.user.stack || '')}üéâ`;
            return ctx.replyTo(`${ctx.user.stack}\n–í–∞—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º—É–∑–µ–µ –ü—Ä–µ—Å–Ω–∏ –°–∏—Ç–∏: ${result[0].cnt} —à—Ç.`);

        }).catch(() => {

            ctx.user.stack = `${(ctx.user.stack || '')}üéâ`;
            return ctx.replyTo(ctx.user.stack);
        })

    }, if_registered(mw_search_stack)));

	bot.on		('new_chat_members', if_public(mw_welcome));
	//bot.on	('left_chat_member', mw_hide_kick);
	bot.on		('left_chat_member', mw_hide_leaving);
	bot.hears	(REX_ESTR, reply("–í–æ–∏—Å—Ç–∏–Ω—É –í–æ—Å–∫—Ä–µ—Å–µ! üéâüê∞"));

    /// –î–∞–ª–µ–µ –∏–¥—É—Ç —Å–∫–∏–ª–∏—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –≤ private-—á–∞—Ç–µ
	bot.use		(mw_private_or_system_chats_only);
	bot.use		(mw_debug_reflection);
    bot.use		(mw_blocked_users);
    bot.start	(if_registered(mw_intoduction_existing, mw_intoduction_new));
	bot.use		(stage.middleware());
    bot.hears   (/^\s*\d{3}\s+\d{1,2}\s*$/, if_chat(917408627, mw_window_show_contact))
    bot.hears   (/^\s*\d{3}\s+\d{1,2}\s*$/, if_chat(771172117, mw_window_show_contact))
	bot.on      ('forward', 	if_private(mw_user_info))
    bot.command	('/menu', 		mw_menu);
    bot.action	('/menu', 		mw_menu);
    bot.hears	(REX_MENU,		mw_menu);
    bot.hears	(REX_APPT,		mw_start_registration);
    bot.hears	(REX_THNX,		ctx => ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞!'));
    bot.action	(REX_RECV,		mw_money_recieve);
    bot.action	(REX_CONF,		mw_accept_documents);
    bot.action	('reject-doc',	mw_reject_documents);
    bot.action	('reply',		mw_unknown_message_reply);
    bot.action	('/join',		mw_request_registration);
    bot.action	('/confirm', 	mw_confirm);
    bot.command	('/confirm', 	mw_confirm);
    bot.command	('/approve',	mw_accept_documents_manual);
    bot.command	('/me',			if_private(mw_me, ctx => ctx.deleteMessage()));
    bot.hears	(['me','Me','–º–µ','–ú–µ'], mw_me );
    bot.hears	(/^(.{1,3}|\s+)?–æ–∫–Ω[–∞–æ](.{1,3}|\s+)?$/i, if_private(if_registered(mw_wash_windows)));
    bot.hears	(/^(.{1,3}|\s+)?(–ø–æ–º—ã—Ç—å\s+)*–æ–∫–Ω[–∞–æ](\s*–∞–ª—å–ø–∏–Ω–∏—Å—Ç.*)?(.{1,3}|\s+)?$/i, if_private(if_registered(mw_wash_windows)));
	bot.hears	(/^(\s+)?–º–æ–π–∫–∞ –æ–∫(–æ–Ω|–Ω–∞)/i, if_private(if_registered(mw_wash_windows)));
    bot.hears	(/^(.{1,3}|\s+)?–º—ã—Ç—å?[—ë–µ–æ]\s+(–æ–∫–Ω–∞|–æ–∫–æ–Ω)(\s*–∞–ª—å–ø–∏–Ω–∏—Å—Ç.*)?(.{1,3}|\s+)?$/i, if_private(if_registered(mw_wash_windows)));
    bot.command	('/okna', if_private(if_registered(mw_wash_windows)));
    bot.action	('/okna', if_private(if_registered(mw_wash_windows)));

    bot.command	('/help',		mw_help);
    bot.hears	(['?','/?'],	mw_help);
	bot.command (['/chats', '/chat'],								if_private(ctx => ctx.reply(BOT_MSG_RESOURCES, Extra.HTML())));
    bot.action  (['/chats', '/chat'],								if_private(ctx => ctx.reply(BOT_MSG_RESOURCES, Extra.HTML())));
	bot.hears	(['chat','chats', '—á–∞—Ç—ã', '–ß–∞—Ç—ã', '—á–∞—Ç', '–ß–∞—Ç'],	if_private(ctx => ctx.reply(BOT_MSG_RESOURCES, Extra.HTML())));
    bot.action  ('/service',                                        if_private(ctx => ctx.scene.enter('order-service')))
    bot.command ('/service',                                        if_private(ctx => ctx.scene.enter('order-service')))
	bot.command	('/budgetcorr',					mw_send_correction);
	bot.action	(actions.broadcast,				mw_broadcast);
    bot.command	('/send',						mw_broadcast_preview);

    /// –î–∞–ª–µ–µ –∏–¥—É—Ç —Å–∫–∏–ª–∏—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —à–∞—Ö–º–∞—Ç–∫–µ
    bot.command ('/santa_send', if_registered(mw_santa_sendout_reminder));
    bot.command ('/santa_send_buttons', if_registered(mw_santa_sendout_ready_buttons));
    bot.action  (actions.santa_get,     if_registered(mw_santa_get));
    bot.action  (actions.santa_clear,   if_registered(mw_santa_clear));
    bot.action  (actions.santa_ready,   if_registered(mw_santa_ready));

    bot.action	('/floor',		if_registered(mw_search_floor));
    bot.action	('/stack',		if_registered(mw_search_stack));
    bot.action	('/tower',		if_registered(mw_search_tower));
    bot.action	('/protection', if_registered(mw_get_protection));
    bot.command	('/floor',		if_registered(mw_search_floor));
    bot.command	('/stack',		if_registered(mw_search_stack));
    bot.command	('/tower',		if_registered(mw_search_tower));
	bot.command ('/protection', if_registered(mw_get_protection));
	bot.action	('/news',		get_safe_mw(get_mw_news_reader('news_chat', false, BOT_MSG_NOTHINGNEW_NEWS_PRIVATE, BOT_MSG_NOTHINGNEW_NEWS_PUBLIC)));
    bot.hears	(['news', 'News', '#news', '@news', ' /news'],	get_safe_mw(get_mw_news_reader('news_chat', false, BOT_MSG_NOTHINGNEW_NEWS_PRIVATE, BOT_MSG_NOTHINGNEW_NEWS_PUBLIC)));
    bot.hears	(['lawyer', 'Lawyer', 'lawer', 'Lawer'],		get_safe_mw(mw_money_offer, BOT_MSG_LAWYER_NEEDS_CONFIRMATION));
    bot.on		(['photo', 'document'], if_registered(mw_request_approval));
    bot.hears 	(['–ü–ª—ë–Ω–∫–∞', '–ø–ª—ë–Ω–∫–∞', '–ü–ª–µ–Ω–∫–∞', '–ø–ª–µ–Ω–∫–∞'], if_registered(mw_get_protection));
    bot.action	('cms_item_remove'  , mw_cms_remove);
    bot.action	('cms_item_unhide'  , mw_cms_unhide);
    bot.action  (/wash_conf:.+/     , mw_wash_confirmatiom );
    bot.action  (['wash_vote_ar:no', 'wash_vote_ar:yes'] , mw_wash_vote_antirain );
    bot.command ('/wash_broadcast'  , mw_wash_broadcast);
    bot.command	('/u', ctx => {

        let cmd = ctx.update.message.text.substring(3);

        return ctx.db
            .query(`select *, out('owned'):{id, floor, tower} as apt, out('confirmation') as conf from user where any() like '%${cmd}%'`)
            .then(result => Promise.all(result.map(user => ctx
                    .reply(toString(user['@data'] || user))
                    .then(() => ctx.reply(user.link, Extra.HTML()))
                    .catch(err => ctx.reply(toString(err)))
            )));
    });

    bot.command	('/a', ctx => {

        let cmd = ctx.update.message.text.substring(3);

        return ctx.db
            .query(`select id, floor, tower.name, windows, in('owned'):{id, username, firstname, lastname, @rid} as owners from apartment where id = ${cmd}`)
            .then(result => Promise.all(result.map(apt => ctx
                    .reply(toString(apt['@data'] || apt))
                    .then(() => (apt.owners.length > 0) && ctx.reply(toText(apt.owners, '<a href="tg://user?id={id}">{username:{$} (}{firstname:{$} }{lastname:{$}}{username:)}</a>'), Extra.HTML()))
                    .catch(err => ctx.reply(toString(err)))
            )))
            .then(() => ctx.db.query_one(`select from wash_budget_2020_03 where ${cmd} in apts.id`))
            .then(wash => wash && ctx.reply(toString(wash)))
    });


    bot.command('/qu', mw_parse_args, ctx => {

        console.log("\nCTX ARGS:", ctx.args);
        return ctx.reply(ctx.args);
    })


    bot.command	('/q', ctx => {

        trace.info("QUERY", ctx.update);
        ctx.reply(ctx.update.message.text.substring(3));

        return ctx.db.query(ctx.update.message.text.substring(3)).then(result => {

            if (Array.isArray(result)) result = result.map(i => { return i['@data'] || i });
            trace.info("QUERY RESULT:", result);
            return ctx.reply(JSON.stringify(result, null, "\t"), Extra.HTML());

        }).catch(err => {

            trace.info(err);
            return ctx.reply(err);
        });
    });

    bot.command	('/qc', ctx => {

        trace.info("QUERY", ctx.update);
        ctx.reply(ctx.update.message.text.substring(4));

        return ctx.db.command(ctx.update.message.text.substring(3)).then(result => {

            if (Array.isArray(result)) result = result.map(i => { return i['@data'] || i });
            trace.info("QUERY RESULT:", result);
            return ctx.reply(JSON.stringify(result, null, "\t"));

        }).catch(err => {

            trace.info(err);
            return ctx.reply(err);
        });
    });


    bot.command	('/up', ctx => {

        trace.info("USER PICTURE", ctx.update);
        ctx.reply(ctx.update.message.text.substring(4));

		const user_id = ctx.update.message.text.substring(3)

		return bot.api.get

        return ctx.db.command().then(result => {

            if (Array.isArray(result)) result = result.map(i => { return i['@data'] || i });
            trace.info("QUERY RESULT:", result);
            return ctx.reply(JSON.stringify(result, null, "\t"));

        }).catch(err => {

            trace.info(err);
            return ctx.reply(err);
        });
    });

    bot.command ('/delete', ctx => {

        trace.info('DELETE MSG');

        return ctx.bot.telegram
            .deleteMessage(-1001496098878, 137512)
            .then(r => { console.log('\n\nDELETE RESULT:', r, '\n\n'); return r; } )
            .then(r => ctx.reply(JSON.stringify(r)))
            .catch(trace.error);
    });

    //{"id": "1", "answer": "yes"}
    //{"id": "2", "answer": "no"}
    bot.action(/^\{"vote":\{.+\}\}$/i, ctx => {

        let data = JSON.parse(ctx.update.callback_query.data);

        trace.info("VOTE", data.vote, {link: ctx.user.link, fname: ctx.user.firstname, lname: ctx.user.lastname, id: ctx.user.id});

        if (data.vote.id == 1) {

            return ctx.editMessageReplyMarkup(Markup.inlineKeyboard([
                [Markup.callbackButton("–î–∞, –≥–æ–ª–æ—Å–æ–≤–∞–ª",		`{"vote":{"id":11,"answer":"yes"}}`)],
                [Markup.callbackButton("–ù–µ—Ç, –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª",	`{"vote":{"id":11,"answer":"no"}}`)],
            ])).then(() => ctx.reply('–£–ø—Å... –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å –≤–∞—à–∏–º –≤—ã–±–æ—Ä–æ–º –µ—â–µ —Ä–∞–∑, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞!'))
        }

        return ctx.db.insert("vote", {

            vote_id: data.vote.id,
            user_id: ctx.user.id,
            user: ctx.user._rid,
            answer: data.vote.answer

        }).then(() => {

            if (data.vote.id == 3) {

                if (data.vote.answer == 'need help') {

                    return ctx.reply("–ü—Ä–∏–Ω—è—Ç–æ. –° –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –∫—Ç–æ-—Ç–æ –∏–∑ —Å–æ—Å–µ–¥–µ–π –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è")
                    .catch(trace_err(data.vote, ctx.user))
                    .then(() => ctx.bot.telegram.sendMessage(CHT_ATTN, `${ctx.user.link} –ø—Ä–æ—Å–∏—Ç –ø–æ–º–æ—â–∏ —Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ–º`))
                    .catch(trace_err(data.vote, ctx.user))
                    .then(() => ctx.bot.telegram.sendMessage(-397672144, `${ctx.user.link} –ø—Ä–æ—Å–∏—Ç –ø–æ–º–æ—â–∏ —Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ–º`))
                }

                return ctx.reply("–ü—Ä–∏–Ω—è—Ç–æ. –°–ø–∞—Å–∏–±–æ!");
            }

            else {

                let nxt = (1 + data.vote.id) % 10;
                return ctx.reply(BOT_QUIZ[nxt].msg, BOT_QUIZ[nxt].extra)
            }
        });
    });



    //{"type": "apt", "name1": "–∫–≤–∞—Ä—Ç–∏—Ä–∞", "name2": "–∫–≤–∞—Ä—Ç–∏—Ä—ã"}
    //{"type": "parking", "name1": "–ø–∞—Ä–∫–æ–≤–∫–∞", "name2": "–ø–∞—Ä–∫–æ–≤–∫–∏"}
    //{"type": "storage", "name1": "–∫–ª–∞–¥–æ–≤–∫–∞", "name2": "–∫–ª–∞–¥–æ–≤–∫–∏"}
    bot.action(/^\{"prop":\{.+\}\}$/i, ctx => {

        ctx.session.prop = JSON.parse(ctx.update.callback_query.data)['prop'];
        return ctx.scene.enter('add-prop');
    });



    //{"type": "ddu"}
    //{"type": "app"}
    //{"type": "pdkp"}
    //{"type": "dkp"}
    //{"type": "egrn"}
    bot.action(/^\{"docs":\{.+\}\}$/i, ctx => {

        ctx.session.doc = JSON.parse(ctx.update.callback_query.data)['docs'];
        return ctx.scene.enter('add-docs');
    });




    bot.command('/zakrytiy', ctx => {

        return ctx.bot.telegram.exportChatInviteLink(CHT_PRIV).then(link => ctx.reply(link));
    })





    bot.action(REX_FILM, if_registered(ctx => {

        ctx.deleteMessage();

        let data = JSON.parse(ctx.update.callback_query.data)["film"];

        return ctx.db.select_one({select:'*, tower:{*}', from:'film', where:{id: data.id}}).then(film => {

            if (!film) {

                trace.error("ERROR: the film is not found!", film);
                return ctx.reply("–¢–∞–∫–∞—è –ø–ª–µ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }

            if (film.claimed_by) {

                trace.error("ERROR: this film is already occupied!", film);
                return ctx.reply("–≠—Ç–∞ –ø–ª–µ–Ω–∫–∞ —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞!");
            }

            return ctx.db.update(film._rid, {claimed_by: ctx.user._rid, claimed_on: Date.now()}).then(() => {

                return ctx.reply(`–°–ø–∞—Å–∏–±–æ! –ù–æ–º–µ—Ä –≤–∞—à–µ–π –ø–ª–µ–Ω–∫–∏ –¥–ª—è ${film.floor} —ç—Ç. (${film.tower.name}):\n\n<b>${data.id}</b>\n\n–ü—Ä–æ–¥–∏–∫—Ç—É–π—Ç–µ –µ–≥–æ –±–∞—Ä–º–µ–Ω—É –≤ –∫–∞—Ñ–µ –ü—Ä–æ–≥—Ä–µ—Å—Å (–ü—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π –≤–∞–ª, 38 - –ø—è—Ç—å –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º –æ—Ç –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏) –∏ –±–∞—Ä–º–µ–Ω –≤—ã–¥–∞—Å—Ç –≤–∞–º –∫–æ–º–ø–ª–µ–∫—Ç –∏–∑ —Ç—Ä—ë—Ö –≤–µ—â–µ–π:\n1. –ó–∞—â–∏—Ç–Ω–∞—è –ø–ª–µ–Ω–∫–∞\n2. –¢—Ä–∞—Ñ–∞—Ä–µ—Ç –ø–æ–¥ —Ä–∞–∑–º–µ—Ä—ã –Ω–∞—à–∏—Ö –≤—ã–∑—ã–≤–Ω—ã—Ö –ø–∞–Ω–µ–ª–µ–π\n3. –ö–æ–Ω–≤–µ—Ä—Ç —Å –Ω–∞–∫–ª–µ–π–∫–∞–º–∏\n\n–ò –Ω–µ –∑–∞–±—É–¥—å—Ç–µ, —á—Ç–æ —É –∂–∏—Ç–µ–ª–µ–π –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏ –≤ –∫–∞—Ñ–µ –ü—Ä–æ–≥—Ä–µ—Å—Å –µ—Å—Ç—å —Å–∫–∏–¥–∫–∞ 20% –Ω–∞ –ª—é–±–æ–π –∫–æ—Ñ–µ - –æ—Ç —ç—Å–ø—Ä–µ—Å—Å–æ –¥–æ —Ñ–ª—ç—Ç-—É–∞–π—Ç–∞.`, Extra.HTML());
            });
        });
    }));





    bot.hears(REX_RELS, if_film_chat(ctx => {

        let id = ctx.update.message.text;

        return ctx.db.select_one({select:'*, tower:{*}, claimed_by:{*}', from:'film', where:{id: id}}).then(film => {

            if (!film) {

                trace.error("ERROR: the film is not found!", film);
                return ctx.reply("–¢–∞–∫–æ–π –ø–ª–µ–Ω–∫–∏ –Ω–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ!");
            }

            if (!film.claimed_by) {

                trace.error("ERROR: this film hasn't been claimed yet!", film);
                return ctx.reply("–≠—Ç–∞ –ø–ª–µ–Ω–∫–∞ –µ—â–µ –Ω–∏–∫–µ–º –Ω–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞!");
            }

            if (film.released_by) {

                trace.error("ERROR: this film has been released already!", film);
                return ctx.reply("–≠—Ç–∞ –ø–ª–µ–Ω–∫–∞ —É–∂–µ –±—ã–ª–∞ –≤—ã–¥–∞–Ω–∞!");
            }

            return ctx.db.update(film._rid, {released_by: ctx.user._rid, released_on: Date.now()}).then(() => {

                return ctx.reply(`–ü—Ä–∏–Ω—è—Ç–æ! –û—Ç–¥–∞–π—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à–µ–º—É –≥–æ—Å—Ç—é —Ç—Ä–∏ –≤–µ—â–∏:\n1. –ó–∞—â–∏—Ç–Ω—É—é –ø–ª—ë–Ω–∫—É\n2. –õ–∏—Å—Ç–æ–∫ —Å —Ç—Ä–∞—Ñ–∞—Ä–µ—Ç–æ–º\n3. –ö–æ–Ω–≤–µ—Ä—Ç —Å –Ω–∞–∫–ª–µ–π–∫–∞–º–∏.\n\n–°–ø–∞—Å–∏–±–æ!!!`).catch(trace.error);

            }).then(() => {

                return ctx.bot.telegram.forwardMessage(film.claimed_by.chat, CHT_FILM, 79).catch(trace.error);

            }).then(() => {

                return ctx.bot.telegram.forwardMessage(film.claimed_by.chat, CHT_FILM, 110).catch(trace.error);
            });
        });
    }));

    bot.command ('/key',        ctx => ctx.reply(access_card_id(ctx.update.message.text)));
    bot.command ('/kick',       mw_kick_out(701033582, -1001400315794));

    /// –≠—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä –≤ —Ü–µ–ø–æ—á–∫–µ - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–æ—É—Ç—è—Ç—Å—è –≤ —Å–ø–µ—Ü.—á–∞—Ç
    //bot.hears	(REX_APP2,		mw_start_registration);
    bot.command	('/stat', 		stat);

    bot.action(actions.santa_accept, ctx => {

        return ctx.db
            .register_santa(ctx.user)
            .then(() => ctx.reply('–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞–ª –≤–∞—Å.\n\n28-–≥–æ —á–∏—Å–ª–∞ –ø—Ä–∏—à–ª—é –≤–∞–º –∏–º—è —Ç–æ–≥–æ —Å—á–∞—Å—Ç–ª–∏–≤—Ü–∞, –∫–æ—Ç–æ—Ä–æ–º—É –≤–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫ –Ω–∞ —ç—Ç–æ—Ç –Ω–æ–≤—ã–π –≥–æ–¥. –ê –ø–æ–∫–∞ –º–æ–∂–µ—Ç–µ —É–∂–µ –æ–±–¥—É–º—ã–≤–∞—Ç—å –∏–¥–µ–∏ –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞ :)'), () => ctx.reply('–£–ø—Å, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞'))
            .then(() => ctx.editMessageReplyMarkup());
    });

    bot.action(actions.santa_decline, ctx => {
    
        return ctx
            .reply('–û–∫, –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é')
            .then(() => ctx.deleteMessage())
    })

    bot.command('/login', mw_login)
    bot.on('message', mw_unknown_message)
}





////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////// TOOLS ////////////////////////////////////////////////////////////////////////////////////////////

function mw_logger(ctx, next) {

    console.log(ctx.update)
    return next()
}

function mw_valid_user_only(ctx, next) {

    if (ctx.user && typeof ctx.user === 'object' && ctx.user.id) return next()
}

function mw_upgarde_ctx(ctx, next) {

	/*

	let reply = ctx.reply;

	ctx.reply = (msg, extra) => {

		trace.info("SENDING REPLY", {to: ctx.from, chat: ctx.chat, reply: msg});
		return reply(msg, extra);
	}

	*/

	ctx.replyAutoDelete = (msg, extra) => {

		trace.info("SENDING SELF-DESTROY REPLY", {to: ctx.from, chat: ctx.chat, reply: msg});
		return ctx.bot.telegram.sendMessage(ctx.chat.id, msg, extra).then(m => {

			setTimeout(() => ctx.bot.telegram.deleteMessage(m.chat.id, m.message_id).catch(trace.error), TM_DELET)
		});
	}

	ctx.replyAutoDeleteTo = (msg) => {

		let inReplyTo = ctx.update && ctx.update.message && ctx.update.message.message_id && Extra.inReplyTo(ctx.update.message.message_id) || undefined;
		return ctx.replyAutoDelete(msg, inReplyTo);
	}

	return next();
}



function get_mw_reply(msg) {

	return (ctx) => {

		return ctx.replyAutoDeleteTo(msg);
	};
};



function reply(msg) {

	return (ctx) => {

		return ctx.replyTo(msg);
	};
};





function trace_err(...inputs) {

	return (err) => trace.error(err, ...inputs);
}





function groupBy (arr, ...keys) {

    let key = keys.shift();
    if (!key) return arr;
    if (!Array.isArray(arr)) return arr;

    let result = arr.reduce((cur, x) => {

        if (!cur.has(x[key])) cur.set(x[key],[]);
        cur.get(x[key]).push(x);
        return cur;

    }, new Map());

    if (keys.length > 0) {

        result.forEach((i, k, m) => {

            m.set(k, groupBy(i, ...keys));
        });
    }

    return result;
};





function buildNeighboursHTML(arr, titleMessage = "", defaultMessage = "<i>(—Å–æ—Å–µ–¥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)</i>") {

	if(!arr) return defaultMessage;
	if(!Array.isArray(arr)) return defaultMessage;
	if(!arr.length) return defaultMessage;

	let msg = [titleMessage];

	groupBy(arr, "tower", "floor").forEach((t, name) => {

		msg.push(`<b>${name}:</b>`);

		t.forEach((f, name) => {

			msg.push(`<b>${name} —ç—Ç:</b> ${Array.from(f.values()).map(i => i.link).join(', ')}`);
		})
	});

	return msg.join("\n");
}





////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////// MIDDLEWARES //////////////////////////////////////////////////////////////////////////////////////

function answer_callback(ctx, next) {

    if (ctx.updateType === 'callback_query') {

        return next().finally(() => ctx.answerCbQuery());
    }

    return next();
}



function mw_parse_args(ctx, next) {

	ctx.args = ctx.update.message.text.replace(/\s*\/\w+(@\w+)(\b|\s+)/, '');
	console.log('\n\nMW_PARSE_ARGS:', ctx.update.message.text, ctx.args);
	return next(ctx);
}



function if_public(mw, mw_not = TELEGRAF.passThru()) {

	return (ctx, next) => {

		return ctx.chat.type == 'private' ? mw_not(ctx, next) : mw(ctx, next);
	};
};



function if_private(mw, mw_not = TELEGRAF.passThru()) {

	return (ctx, next) => {

		return ctx.chat.type == 'private' ? mw(ctx, next) : mw_not(ctx, next);
	};
};



function if_chat(chat, mw, mw_not = TELEGRAF.passThru()) {

    if (Array.isArray(chat)) {

        return (ctx, next) => {

            return chat.includes(ctx.chat.id) ? mw(ctx, next) : mw_not(ctx, next);
        }
    }

	return (ctx, next) => {

		return ctx.chat.id == chat ? mw(ctx, next) : mw_not(ctx, next);
	};
};


function if_film_chat(mw, mw_not = TELEGRAF.passThru()) {

	return (ctx, next) => {

		return ctx.chat.id == CHT_FILM ? mw(ctx, next) : mw_not(ctx, next);
	};
};



function if_registered(mw, mw_not = get_mw_reply(BOT_MSG_NEED_REGISTRATION)) {

	return (ctx, next) => {

		return ctx.user.apartments.then(result => {

			return (result && result.length > 0) ? mw(ctx, next, result) : mw_not(ctx, next);
		});
	};
};



function if_registered_or_exception(mw, mw_not = get_mw_reply(BOT_MSG_NEED_REGISTRATION)) {

	return (ctx, next) => {

		if (ctx.from.id === USR_ZOTOV) {

			return mw(ctx, next);
		};

		if (ctx.from.id === USR_NICKY) {

			return mw(ctx, next);
		};

		return ctx.user.apartments.then(result => {

			return (result && result.length > 0) ? mw(ctx, next, result) : mw_not(ctx, next);
		});
	};
};



function if_confirmed(mw, mw_not = get_mw_reply(BOT_MSG_NEED_CONFIRMATION)) {

	return (ctx, next) => {

		return ctx.user.confirmations.then(result => {

			return (result && result.length > 0) ? mw(ctx, next, result) : mw_not(ctx, next);
		});
	};
};



function get_safe_mw(mw, msg_non_confirmed = BOT_MSG_NEED_CONFIRMATION_PUBLIC, msg_non_registered = BOT_MSG_NEED_REGISTRATION_PUBLIC) {

	return if_confirmed(
		mw,
		if_registered(
			get_mw_reply(msg_non_confirmed),
			get_mw_reply(msg_non_registered)
		)
	);
}



function mw_private_or_system_chats_only(ctx, next) {

	if (ctx.chat.type === 'private')	return next(ctx);
	if (CHT_SYST.includes(ctx.chat.id))	return next(ctx);
};



function mw_blocked_users(ctx, next) {

	if (ctx.isPrivate) {

		if (ctx.user.blocked) {

			return ctx
				.forwardMessage(CHT_ATTN)
				.finally(() => ctx.reply(`–ò–∑–≤–∏–Ω—è—é—Å—å, –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∑–∞ –ø–æ–º–æ—â—å—é –∫ <a href="tg://user?id=${SETTINGS.support_id}">–ø–æ–¥–¥–µ—Ä–∂–∫–µ, –∫–ª–∏–∫–Ω—É–≤ –Ω–∞ —ç—Ç—É —Å—Å—ã–ª–∫—É</a>`, Extra.HTML()));
		}
	}

	return next(ctx);
};



function mw_debug_reflection(ctx, next) {

	return next(ctx).then(() => {

		let msg =
		ctx.message && ctx.message.text ||
		ctx.update.callback_query && ctx.update.callback_query.message && [ctx.update.callback_query.data, ctx.update.callback_query.message.text, ctx.update.callback_query] ||
		ctx.update;

		trace.info(`REFLECTION ${ctx.updateType}::${ctx.updateSubTypes}`, msg, ctx.user);
	});
};



function mw_search_floor(ctx) {

	return ctx.user.neighbours_floor.then(nbs => {

		trace.info("SEARCH RESULT [FLOOR]", ctx.from, nbs);
		trace.info("DEBUG", { replyWithHTML: typeof ctx.replyWithHTML });

		return ctx.replyWithHTML(buildNeighboursHTML(nbs,
			'–í–∞—à–∏ —Å–æ—Å–µ–¥–∏ –ø–æ —ç—Ç–∞–∂—É:',
			'<i>–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –∏–∑ –±–ª–∏–∂–∞–π—à–∏—Ö –∫ –í–∞–º —Å–æ—Å–µ–¥–µ–π –ø–æ —ç—Ç–∞–∂—É –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –≤ —à–∞—Ö–º–∞—Ç–∫–µ. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è, —è —Å—Ä–∞–∑—É –∂–µ —Å–æ–æ–±—â—É –í–∞–º –æ–± —ç—Ç–æ–º.</i>'
		));

	}).catch(trace.error);
};



function mw_search_stack(ctx) {

	return ctx.user.neighbours_stack.then(nbs => {

		trace.info("SEARCH RESULT [STACK]", ctx.from, nbs);

		return ctx.replyWithHTML(buildNeighboursHTML(nbs,
			'C–æ—Å–µ–¥–∏ –ø–æ —Å—Ç–æ—è–∫—É - –Ω–∞–¥ –≤–∞–º–∏ –∏–ª–∏ –ø–æ–¥ –≤–∞–º–∏:',
			'<i>–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –∏–∑ –±–ª–∏–∂–∞–π—à–∏—Ö –∫ –í–∞–º —Å–æ—Å–µ–¥–µ–π –ø–æ —Å—Ç–æ—è–∫—É –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –≤ —à–∞—Ö–º–∞—Ç–∫–µ. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è, —è —Å—Ä–∞–∑—É –∂–µ —Å–æ–æ–±—â—É –í–∞–º –æ–± —ç—Ç–æ–º.</i>'
		));

	}).catch(trace.error);
};



function mw_search_tower(ctx) {

	return ctx.user.neighbours_tower.then(nbs => {

		trace.info("SEARCH RESULT [TOWER]", ctx.from, nbs);

		return ctx.replyWithHTML(buildNeighboursHTML(nbs,
			'C–æ—Å–µ–¥–∏ –ø–æ –±–∞—à–Ω–µ:',
			'<i>–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –∏–∑ —Å–æ—Å–µ–¥–µ–π –≤ –≤–∞—à–µ–π –±–∞—à–Ω–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è, —è —Å—Ä–∞–∑—É –∂–µ —Å–æ–æ–±—â—É –í–∞–º –æ–± —ç—Ç–æ–º.</i>'
		));

	}).catch(trace.error);
};



function get_mw_collector(className) {

	return (ctx, next) => {

		if (ctx.chat.type === 'private') return next(ctx);

		let msgs = [];
		if (ctx.update.message.reply_to_message) msgs.push(ctx.update.message.reply_to_message);

		let isTooShort = ctx.update.message.entities && ctx.update.message.entities.reduce((rv, x) => {return rv + x.length}, 0);
			isTooShort = ctx.update.message.text.length - (isTooShort || 0);
			isTooShort = isTooShort < 10;
		if(!isTooShort) msgs.push(ctx.update.message);

		trace.info(`GOING TO STORE MESSAGE [class: ${className}, by: ${ctx.user.username}]`, msgs);

		return Promise.all(

			msgs.filter(i => !ctx.chatinfo.isHidden(i.chat.id)).map(i => {

				return ctx.bot.telegram.forwardMessage(CHT_NEWS, i.chat.id, i.message_id).catch(trace.error).then(() => {

					return ctx.user._save_message(className, i).catch(trace.error);
				});
			})

		).then(news => {

			/* ATTENTION! - neeeds to be updated to new WF middleware
			return ctx.web.postnews(news.filter(i => ctx.chatinfo.isPublic(i.chat.id)));
			*/
		});
	};
};



function get_mw_news_reader(
								newsClass,
								all = false,
								nonews_private = BOT_MSG_NOTHINGNEW_NEWS_PRIVATE,
								noNews_public = BOT_MSG_NOTHINGNEW_NEWS_PUBLIC
	) {

	return (ctx) => {

		trace.info(`GOING TO READ SOME NEWS [class = ${newsClass}]`, ctx.from, ctx.chat);
		let isPrivate = ctx.chat.type === 'private';

		return ctx.user._retrieve_messages(newsClass, all).then(news => {

			let nCount = news && news.length > 0 && news.length || 0;

			if (nCount < 1) {

				return ctx.replyAutoDeleteTo(isPrivate ? nonews_private : noNews_public); 
			}

			if (nCount > 20) {

				ctx.replyAutoDeleteTo('–º–∏–Ω—É—Ç–∫—É...');
			}

			let n = 0;

			return news.reduce((p, i) => {

				if ((i.sender.id == USR_ZOTOV) && ((ctx.from.id == USR_ZOTOV) || (ctx.from.id == USR_SUPP))) {

					nCount--;
					return p;
				}

				if ((i.sender.id == USR_NICKY) && ((ctx.from.id == USR_NICKY) || (ctx.from.id == USR_SUPP))) {

					nCount--;
					return p;
				}

				if (++n % MAX_MSPS === 0) {

					p = p.then(() => new Promise(resolve => setTimeout(resolve, TM_SLEEP)));
				}

				return [i.reply_to_message, i]
						.filter(x => x && x.message_id && x.chat && x.chat.id)
						.reduce((rv, i) => {

							return rv.then(() => {

								return ctx.telegram.forwardMessage(ctx.from.id, i.chat.id, i.message_id).catch(err => {

									if (!i.text) {
			
										trace.info("ERROR WHILE FORWARDING NEWS TO USER", typeof i, i['@data'] || i, err);
										return --nCount;
									}
			
									return ctx.telegram.sendMessage(ctx.from.id, i.get_html(), Extra.HTML()).catch(err => {
			
										trace.info("ERROR WHILE RESENDING NEWS AS HTML", err);
										return ctx.telegram.sendMessage(ctx.from.id, i.get_text()).catch(err => {
			
											nCount--;
											trace.info("ERROR WHILE RESENDING NEWS AS PLAIN TEXT", err);
										});
									});
								});
							});

						}, p);

				}, Promise.resolve()).then(() => {

					return nCount > 0 && !isPrivate ? ctx.replyAutoDeleteTo(`–û—Ç–ø—Ä–∞–≤–∏–ª –ø–æ–¥–±–æ—Ä–∫—É –≤–∞–º –≤ –ª–∏—á–∫—É (${nCount} —à—Ç.)`) : null ;
				});
			});
	};
};



function mw_request_approval(ctx, next, apts) {

	if (ctx.chat.type !== 'private' || !ctx.update.message.photo) return next(ctx);

	return ctx.forwardMessage(CHT_ATTN).then(() => {

		trace.info(`REQUEST PHOTO APPROVAL [from = ${ctx.user.name}]`, ctx.user, apts);

		let buttons = [[Markup.callbackButton('‚úñÔ∏è–æ—Ç–∫–ª–æ–Ω–∏—Ç—å', "reject-doc"), Markup.callbackButton('–Ω–∞–ø–∏—Å–∞—Ç—å', 'reply')]].concat(apts.map(i => {

			return [Markup.callbackButton(`‚úÖ–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å: ${i.id}`, JSON.stringify({"accept-doc":{apt: i.id}}).trim())];
		}));

		return ctx.bot.telegram.sendMessage(
			CHT_ATTN,
			JSON.stringify({

				ts: Date.now(),
				message: ctx.update.message.message_id,
				sender: ctx.update.message.from,
				chat: ctx.update.message.chat,
				photo: ctx.update.message.photo.reduce((rv, x) => { if (rv.file_size && rv.file_size > x.file_size) return rv; return x }, ctx.update.message.document || {})

			}, null, "\t"),
			Markup.inlineKeyboard(buttons).extra()

		).then(() => {

			return ctx.reply('–°–ø–∞—Å–∏–±–æ! –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É...');
		});
	});
};



function mw_accept_documents(ctx, next) {

	if (!ctx.update.callback_query.message.text) return next(ctx);

	let data = JSON.parse(ctx.update.callback_query.message.text);
		data.callback = JSON.parse(ctx.update.callback_query.data);
		data.callback.by = ctx.from;

	trace.info("GOING TO WRITE DOC ACCEPTANCE", data, ctx.user);
	return ctx.db.select_user_byID(data.sender.id).then(user => {

		if (!user) return trace.info("ACCEPT-DOCS FAILURE: can't find the user", data); 

		return user.write_acceptance(data.callback["accept-doc"].apt, data).then(result => {

			if (!result.success) return trace.info("ACCEPT-DOCS FAILURE:", result, data);

			trace.info(`DOCS ARE ACCEPTED [user = ${user.name}, user_id = ${user.id}, apt = ${data.callback["accept-doc"].apt}, by = ${ctx.user.name}]`, result);
			return ctx.bot.telegram.sendMessage(data.chat.id, "–í–∞—à –î–î–£ –ø—Ä–∏–Ω—è—Ç, –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –¢–µ–ø–µ—Ä—å –≤—ã –≤ —Å–ø–∏—Å–∫–µ —Å–∞–º—ã—Ö –Ω–∞—Å—Ç–æ—è—â–∏—Ö —Å–æ—Å–µ–¥–µ–π –ñ–ö –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏! –£—Ä–∞!").then(() => {

				ctx.resetCachedUser(user.id);

				return ctx.reply(`<b>Acceptance: Done.</b>\n\n[user = ${user.name}, user_id = ${user.id}, apt = ${data.callback["accept-doc"].apt}, by = ${ctx.user.name}]\n\nGet link: /zakrytiy`, Extra.HTML())
					.then(() => ctx.bot.telegram.getChatAdministrators(CHT_PRIV))
					.then(admins => Promise.all(

						admins.map(i => {

							trace.info("SENDING NOTIFICATION TO ADMIN", {admin: i.user, user: user['@data'] || user});
							return ctx.bot.telegram.sendMessage(i.user.id, `–ü—Ä–∏–≤–µ—Ç, –ê–¥–º–∏–Ω –∑–∞–∫—Ä—ã—Ç–æ–≥–æ —á–∞—Ç–∞!\n–ù–∞—à –Ω–æ–≤—ã–π —Å–æ—Å–µ–¥ ${user.link} –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤–ª–∞–¥–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é –≤ –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏, –æ—Ç–ø—Ä–∞–≤–∏–≤ –±–æ—Ç—É —Ñ–æ—Ç–æ –î–î–£.\n–§–æ—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, –∏ —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤ –Ω–∞—à–∏ —Ä—è–¥—ã –Ω–æ–≤–æ–≥–æ —Å–æ—Å–µ–¥–∞!`, Extra.HTML()).catch(trace.error);
						})
					)
				);
			});
		});
	});
};



function mw_accept_documents_manual(ctx) {

	let user_id = ctx.update.message.reply_to_message.forward_from.id;
	let data = ctx.update.message.reply_to_message;
		data = {message: data.message_id, sender: data.forward_from, chat: {id: data.forward_from.id}, photo: data.photo || data.document || {comment: manual}, date: data.date, ts: Date.now()};

	if (Array.isArray(data.photo)) {

		data.photo = data.photo.reduce((rv, x) => { if (rv.file_size && rv.file_size > x.file_size) return rv; return x }, {});
	};

	return Promise.resolve(ctx.update.message.text.match(/\d+/g))
	.then(id => {

		if (id) return id[0];
		return ctx.db.select_one({select: 'id', from: 'apartment', where: `${user_id} in in_owned.out.id`}).then(result => result.id)
	})
	.then(apt_id => {

		trace.info("APROVE", {apt: apt_id});

		return ctx.db.select_user_byID(user_id).then(user => {

			if (!user) return trace.info("ACCEPT-DOCS FAILURE: can't find the user", data); 

			return user.write_acceptance(apt_id, data).then(result => {

				if (!result.success) return trace.info("ACCEPT-DOCS FAILURE:", result, data);

				trace.info(`DOCS ARE ACCEPTED [user = ${user.name}, user_id = ${user.id}, apt = ${apt_id}, by = ${ctx.user.name}]`, result);
				return ctx.bot.telegram.sendMessage(data.chat.id, "–í–∞—à –î–î–£ –ø—Ä–∏–Ω—è—Ç, –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –¢–µ–ø–µ—Ä—å –≤—ã –≤ —Å–ø–∏—Å–∫–µ —Å–∞–º—ã—Ö –Ω–∞—Å—Ç–æ—è—â–∏—Ö —Å–æ—Å–µ–¥–µ–π –ñ–ö –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏! –£—Ä–∞!").then(() => {

					return ctx.reply('Acceptance: Done.');
				});
			});
		});
	});
};



function mw_reject_documents(ctx, next) {

	if (!ctx.update.callback_query.message.text) return next(ctx);

	let data = JSON.parse(ctx.update.callback_query.message.text);
		data.callback = { data: ctx.update.callback_query.data, by: ctx.from };

	trace.info("GOING TO REJECT DOCS", data, ctx.user);

	return ctx.bot.telegram.sendMessage(data.chat.id, `–ò–∑–≤–∏–Ω—è—é—Å—å, –Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –ø—Ä–∏–Ω—è—Ç—ã :(\n–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, —Ç–æ–ª—å–∫–æ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ!... –î–∞–≤–∞–π—Ç–µ –Ω–∞–ø–∏—à–µ–º –æ –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–µ–º ${support}`).then(() => {

		return ctx.reply('Rejection: Done.');
	});
};



function mw_menu(ctx, next, msg = "–ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?") {

    console.log('MW_MENU with msg=', msg);

    if (!ctx.isPrivate) {

        console.log('\n\nMW_MENU - DELETE MSG')
        return ctx.deleteMessage()
    }

    return ctx.reply(msg, Markup.inlineKeyboard([

        [ Markup.callbackButton("–°–æ—Å–µ–¥–∏ –ø–æ —ç—Ç–∞–∂—É", "/floor") ],
        [ Markup.callbackButton("–°–æ—Å–µ–¥–∏ –ø–æ —Å—Ç–æ—è–∫—É", "/stack") ],
        [ Markup.callbackButton("–î–æ–±–∞–≤–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É", "/join") ],
        [ Markup.callbackButton("–ó–∞–∫—Ä—ã—Ç—ã–π —á–∞—Ç", "/confirm") ],
        [ Markup.callbackButton("–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏", "/chats") ],
		[ Markup.callbackButton("–ü–æ–º—ã—Ç—å –æ–∫–Ω–∞ –∞–ª—å–ø–∏–Ω–∏—Å—Ç–∞–º–∏", "/okna") ]

    ]).extra());

    /*
        [ Markup.loginButton('–ü–æ–º—ã—Ç—å –æ–∫–Ω–∞ –∞–ª—å–ø–∏–Ω–∏—Å—Ç–∞–º–∏', 'https://presnya.shop/login') ]
    */
}





function mw_menu_short(ctx, next, msg = "–ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?") {

    if (!ctx.isPrivate) {

        console.log('\n\nMW_MENU_SHORT - DELETE MSG')
        return ctx.deleteMessage()
    }

    return ctx.reply(msg, Markup.inlineKeyboard([

        [ Markup.callbackButton("–ü–æ–º—ã—Ç—å –æ–∫–Ω–∞ –∞–ª—å–ø–∏–Ω–∏—Å—Ç–∞–º–∏", "/okna") ],
        [ Markup.callbackButton("–í—Å—ë –º–µ–Ω—é", "/menu") ]

    ]).extra())
}





function mw_help(ctx, next) {

	return mw_menu(ctx, next, `–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –∏–ª–∏ –ø–æ—Å–µ—Ç–∏—Ç –∏–¥–µ—è, –∏–ª–∏ –æ–¥–æ–ª–µ–µ—Ç —á—É–≤—Å—Ç–≤–æ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –∫–∞–∫–æ–≥–æ-—Ç–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ - —Å–º–µ–ª–æ –ø–∏—à–∏—Ç –§–µ–¥–æ—Ä—É: ${support}\n\n–ú–µ–Ω—é:`);
};



function mw_confirm(ctx) {

	return ctx.privateReply(BOT_MSG_HOWOT_CONFIRM);
}



function mw_intoduction_new(ctx) {

	return ctx.reply(
		"–ü—Ä–∏–≤–µ—Ç, —Å–æ—Å–µ–¥! –Ø –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –≤–∞—à–∏—Ö —Å–æ—Å–µ–¥–µ–π –≤ –ñ–ö –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏. –î–ª—è –Ω–∞—á–∞–ª–∞, –¥–∞–≤–∞–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º—Å—è –≤ —à–∞—Ö–º–∞—Ç–∫–µ. –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –Ω–æ–º–µ—Ä —Å–≤–æ–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã. –Ø –µ–≥–æ –Ω–∏–∫–æ–º—É –Ω–µ —Å–∫–∞–∂—É. –°–æ—Å–µ–¥–∏ –±—É–¥—É—Ç –∑–Ω–∞—Ç—å –≤–∞—à —ç—Ç–∞–∂ –∏ –±–∞—à–Ω—é, –Ω–æ –Ω–µ –Ω–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã.",
		 Markup.keyboard(['–ú–µ–Ω—é']).resize().extra()
	);
};



function mw_intoduction_existing(ctx, next, apts) {

		return ctx.replyWithHTML(
			`–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é!\n–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω${apts.length == 1 ? '–∞—è':'—ã–µ'} –≤ —à–∞—Ö–º–∞—Ç–∫–µ –∫–≤–∞—Ä—Ç–∏—Ä${apts.length == 1 ? '–∞':'—ã'}:\n<b>${apts.map(i => i.id).join(', ')}</b>\n–í—ã –º–æ–∂–µ—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â–µ –æ–¥–Ω—É (–∫–∞–∫ –æ–±—ã—á–Ω–æ, –æ—Ç–ø—Ä–∞–≤–∏–≤ –º–Ω–µ –µ—ë –Ω–æ–º–µ—Ä), –∏–ª–∏ –∂–µ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –ø–æ–∏—Å–∫—É —Å–æ—Å–µ–¥–µ–π —Å –ø–æ–º–æ—â—å—é –º–µ–Ω—é:\n${BOT_MENU}`,
			 Markup.keyboard(['–ú–µ–Ω—é']).resize().extra()
		);
};



function mw_welcome(ctx, next) {

	return next(ctx);

	if (ctx.chat.id == -1001496098878 || ctx.chat.id == -1001214733932) {

		return ctx.db
			.query_one('select sum(apts.size()) as count from wash_budget_2020_03')
			.then(result => (result.link = ctx.user.link) && (result.parameter = '–∫–≤–∞—Ä—Ç–∏—Ä' + (['','a','—ã','—ã','—ã'][result.count % 10] || '')) && result)
			.then(result => messages.welcome(ctx).with(result).say())
	}

	return next(ctx);
}



function mw_me(ctx) {

	return ctx.user.apartments.then(apts => {

		return ctx.replyWithHTML(`
<b>${ctx.user.name}</b>

${apts.length > 1 ? '–∫–≤–∞—Ä—Ç–∏—Ä—ã:' : '–∫–≤–∞—Ä—Ç–∏—Ä–∞:'}${apts.reduce((rv, x) => {return `${rv}\n<b>${x.id}</b> (${x.windows.length} –æ–∫–æ–Ω, ${x.floor} —ç—Ç, ${x.tower.name})` }, "")}${apts.length < 1 ? ' –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç' : '' }

–ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–∞–∫–æ–π-—Ç–æ –∫–≤–∞—Ä—Ç–∏—Ä—ã, —Ç–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –µ—ë –Ω–æ–º–µ—Ä, –∏ —è –¥–æ–±–∞–≤–ª—é –µ—ë –≤ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å.
–ï—Å–ª–∏ –µ—Å—Ç—å –ª–∏—à–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∏–ª–∏ –∫–∞–∫–∞—è-—Ç–æ –¥—Ä—É–≥–∞—è –ø—Ä–æ–±–ª–µ–º–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ @fedor_presnya, –∏ –æ–Ω –≤—Å—ë –ø–æ–ø—Ä–∞–≤–∏—Ç.
`
		);
	});

    return ctx.user.apartments.then(apts => {

		return ctx.replyWithHTML(`
<b>${ctx.user.name}</b>
id: ${ctx.user.id}
first name: ${ctx.user.firstname}
last name: ${ctx.user.lastname}
link: ${ctx.user.link}
data: ${JSON.stringify(ctx.user['@data'], null, "\t")}
property:${apts.reduce((rv, x) => {return `${rv}\n<b>${x.id}</b> (${x.floor} —ç—Ç, ${x.tower.name})` }, "")}`
		);
	});
};



function mw_unknown_message_reply(ctx, next) {

	if (!ctx.update.callback_query.message.text) return next(ctx);

	trace.info("GOING TO REPLY TO USER VIA BOT", ctx.update.callback_query.message);

	let data = JSON.parse(ctx.update.callback_query.message.text);
		data.callback = { data: ctx.update.callback_query.data, by: ctx.from };

	ctx.session.reply = data;
	return ctx.scene.enter('reply');
};



function mw_archive(ctx, next) {

	return next(ctx).then(() => {

		if (ctx.from.id == USR_ZOTOV) return ctx.user.save_zotov(ctx.update.message).catch(trace.error);
		if (ctx.from.id == USR_NICKY) return ctx.user.save_nicky(ctx.update.message).catch(trace.error);
	
	}).then(() => {

		if (ctx.update.message && ctx.update.message.entities) {

			return ctx.update.message.entities.filter(x => x.type == 'text_mention').reduce((rv, i) => {

				return rv.then(() => {

					if (i.user.id == USR_ZOTOV) return ctx.user.save_zotov(ctx.update.message).catch(trace.error);
					if (i.user.id == USR_NICKY) return ctx.user.save_nicky(ctx.update.message).catch(trace.error);
				});

			}, Promise.resolve());
		}

	}).then(() => {

		return ctx.update.message && !CHT_SYST.includes(ctx.chat.id) ? ctx.user.save_archive(ctx.update.message) : undefined;
	});
}



function mw_spam_filter(ctx, next) {

	try {

		let msg = ctx.update.message;

		if (msg && msg.forward_from_chat && ((msg.caption && msg.caption.includes('https://t.me/joinchat/')) || (msg.text && msg.text.includes('https://t.me/joinchat/')))) {

			trace.info("SPAM", msg);

			return ctx.bot.telegram.deleteMessage(ctx.chat.id, msg.message_id).catch(trace.error).then(success => {

				if (!success) return ctx.replyTo('spam! –Ω–µ –º–æ–≥—É —É–¥–∞–ª–∏—Ç—å, –Ω–µ—Ç –ø—Ä–∞–≤ :(');
				return success;
			});
		}

		return next(ctx);
	}

	catch {

		return next(ctx);
	}
}



function mw_start_registration(ctx, next) {

	if (!ctx.isPrivate) return next(ctx);
	let id = 1*ctx.message.text.match(REX_APP2).reduce((rv, i) => { if (rv && rv.length > i.length) return rv; return i }, "");

	//252944470 - –ù–∏–∫–æ–ª–∞–π
	//741608 - –ê–ª–∏–Ω–∞ –ë–∏–∫—Ç–∏–º–∏—Ä–æ–≤–∞
	//376662903 - –ö—É–¥—ã–º–æ–≤–∞
	//414971388 - –ê–Ω–∞—Å—Ç–∞—Å–∏—è –•–∞–∑–∏–µ–≤–∞
	//505891600 - –õ—É—Ä—å–µ
	//194212976 - –ò–ª—å—è

	if (Date.now() < 1665871200000) {

		if ([252944470, 741608, 376662903, 414971388, 505891600, 194212976, 202234105].includes(ctx.user.id)) {

			return ctx.db
				.query(`select id, floor, tower.name, in('owned'):{id, username, firstname, lastname, @rid} as owners from apartment where id = ${id}`)
				.then(result => Promise.all(

						result.map(apt => {

							if (apt.owners.length > 0) {

								return ctx.reply(
									`<b>–ö–≤. ${apt.id}</b>\n\n`
										+ (apt.owners.filter(i => i.username).map(i => `@${i.username}\n\n`).join(''))
										+ toText(apt.owners.filter(i => !i.username), '<a href="tg://user?id={id}">{username:{$} (}{firstname:{$} }{lastname:{$}}{username:)}</a>\n\n')
									, Extra.HTML()
								)
							}

							return ctx.reply("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö :(")
						})

					)
					.catch(err => ctx.reply("–°–ª—É—á–∏–ª–∞—Å—å –æ—à–∏–±–∫–∞: " + err && (err.message || err.toString()) || "(–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è)" ))
				)
		}
	}

	ctx.session.reg = { id }
	ctx.scene.enter('reg-confirm')
}



function mw_user_info(ctx) {

	if ([252944470, 741608, 376662903, 414971388, 505891600, 194212976, 202234105].includes(ctx.user.id)) {

		if (ctx.message && ctx.message.forward_from) {

			console.log("\n\n\nFORWARD:", ctx.message.forward_from, "\n\n\n")
			const user = ctx.message.forward_from.id

			if (user) {

				return ctx.db
					.query(`select out('owned'):{id, floor, tower:{name}} as apt from user where id=${user}`)
					.then(profile => {

						if (Array.isArray([profile])) {

							profile = profile[0]
						}

						if (!profile) {

							return ctx.reply('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π')
						}

						if (profile.err) {

							if (profile.err == 2) {

								return ctx.reply('–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞ –Ω–∏–º –∫–≤–∞—Ä—Ç–∏—Ä –≤ @PresnyaBot')
							}

							return ctx.reply(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è.\n–ù–æ–º–µ—Ä –æ—à–∏–±–∫–∏: ${profile.err}\n(${profile.description})`)
						}

						console.log("\n\n\nPROFILE:", profile, "\n\n\n")
						return ctx.reply(profile.apt.map(i => `<b>–∫–≤. ${i.id}</b> (${i.tower.name}, ${i.floor} —ç—Ç)`).join("\n\n"), Extra.HTML());
					})
			}
		}

		return ctx
			.reply('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–µ—Ç–∏–ª —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–µ–±—è –ø—Ä–∏ —Ñ–æ—Ä–≤–∞—Ä–µ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π')
			.then(() => trace.info('FORWARD MESSAGE WRONG FORMAT', ctx.update))
	}
}



function mw_request_registration(ctx, next) {

	if (!ctx.isPrivate) return next(ctx);
	ctx.scene.enter('reg-input');
}



function mw_money_offer(ctx) {

	return ctx.user.make_offer(MNY_SUMM, MNY_DISP).then(offer => {

		if (offer.recieved) {

			return ctx.privateReply(`–°–ø–∞—Å–∏–±–æ! –í–∞—à –≤–∑–Ω–æ—Å –ø–æ–ª—É—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∑–∞–∫—Ä—ã—Ç–æ–≥–æ —á–∞—Ç–∞: ${offer.recieved_by.link}\n\n–ï—Å–ª–∏ –≤–∞—Å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –≤ —á–∞—Ç, –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –º–Ω–µ –æ–± —ç—Ç–æ–º.`);
		};

		return ctx.privateReply(BOT_MSG_LAWYER_WAITING_FOR_PAYMENT).then(() => {

			return ctx.privateReply(`–í–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤–∑–Ω–æ—Å–∞:\n<b>${offer.amount} —Ä—É–±.</b>\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–Ω–æ —ç—Ç—É —Å—É–º–º—É, —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ –∫–æ–ø–µ–µ—á–µ–∫. –ò–Ω–∞—á–µ —è –Ω–µ —Å–º–æ–≥—É –ø–æ–Ω—è—Ç—å, –æ—Ç –∫–æ–≥–æ –ø—Ä–∏—à–ª–∏ –¥–µ–Ω—å–≥–∏.`);

		}).then(() => {

			return ctx.bot.telegram.sendMessage(
				CHT_CASH,
				`–û–∂–∏–¥–∞–µ—Ç—Å—è –≤–∑–Ω–æ—Å –≤ —Ä–∞–∑–º–µ—Ä–µ:\n<b>${offer.amount}</b>\n–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${ctx.user.link}`,
				Extra.HTML().markup(m => m.inlineKeyboard([m.callbackButton('–ø—Ä–∏—à–ª–æ –Ω–∞ –º–æ—é –∫–∞—Ä—Ç—É', `{"recieve-money":{"id":${offer.id}}}`)]))
			);
		});

	}).then(() => {

		if (ctx.chat.type != 'private') {

			return ctx.replyAutoDeleteTo("–û—Ç–ø—Ä–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –í–∞–º –≤ –ª–∏—á–∫—É.");
		};
	});
};



function mw_money_recieve(ctx) {

	let offer = JSON.parse(ctx.update.callback_query.data)["recieve-money"];

	trace.info("GOING TO RECIEVE MONEY", offer, ctx.user);
	return ctx.user.take_credit(offer.id).then(result => {

		if (result && result.success) {

			return Promise.all([
				ctx.editMessageReplyMarkup().catch(trace.error),
				ctx.editMessageText(ctx.update.callback_query.message.text + `\n\n<b>–ó–∞—á–∏—Å–ª–µ–Ω–æ:</b> ${ctx.user.link}\n${new Date()}`, Extra.HTML()).catch(trace.error),
				ctx.replyWithHTML(`–ù–∞ –∫–∞—Ä—Ç—É ${ctx.user.link} –ø–æ—Å—Ç—É–ø–∏–ª –≤–∑–Ω–æ—Å <b>${result.offer.amount}</b> –æ—Ç ${result.creditor.link}.\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Å–µ–¥–∞ –≤ —á–∞—Ç.`).catch(trace.error).then(() => {
					let cash = result.cash.reduce((rv, i) => {return rv + `\n${i.link} => ${i.credit}`}, `–ö–∞—Å—Å–∞: <b>${result.cash.reduce((rv, i) => {return rv + i.credit}, 0)}</b> —Ä—É–±.\n`);
					return ctx.replyWithHTML(cash);
				}).catch(trace.error),
				ctx.bot.telegram.sendMessage(result.creditor.id, `–í–∞—à –≤–∑–Ω–æ—Å ${result.offer.amount} —Ä—É–± –ø–æ—Å—Ç—É–ø–∏–ª –Ω–∞ –∫–∞—Ä—Ç—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: ${ctx.user.link}. –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –æ–Ω –ø—Ä–∏–≥–ª–∞—Å–∏—Ç –í–∞—Å –≤ —á–∞—Ç.`, Extra.HTML()).catch(trace.error)
			]);
		}

		return ctx.reply(`–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –¥–µ–Ω—å–≥–∏ :(\n[offer.id = ${offer.id}]`);
	});
}



function mw_money_cash(ctx, next) {

	if (ctx.chat.id === CHT_LAWR || ctx.chat.id === CHT_CASH) {

		return ctx.db.query(`select *, $c as credit from user let $c=sum(in("credit").id) where in_credit.size()>0 order by $c desc`).then(result => {

			result = result.reduce((rv, i) => {return rv + `\n${i.link} => ${i.credit/100}`}, `–ö–∞—Å—Å–∞: <b>${result.reduce((rv, i) => {return rv + i.credit}, 0)/100}</b> —Ä—É–±.\n`);
			return ctx.replyWithHTML(result);
		});
	};

	return next(ctx);
}



function mw_get_protection(ctx) {

	return ctx.db.query('select from film where claimed_by is not null').then(claims => {

		if (claims.length >= 80) {

			return ctx.reply('–ó–∞—â–∏—Ç–Ω—ã–µ –ø–ª–µ–Ω–∫–∏ —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å! –°–ø–∞—Å–∏–±–æ –≤—Å–µ–º, –∫—Ç–æ –ø—Ä–∏–Ω—è–ª —É—á–∞—Å—Ç–∏–µ.');
		}

		return ctx.db.query(`select @rid as _rid, id, floor, tower.name as tower, claimed_by.id as user from film where tower in (select tower from (select expand(out('owned')) from ${ctx.user._rid})) order by tower, floor desc`).then(films => {

			if (films.filter(i => {return !i.user}).length < 1) {

				return ctx.reply('–í –≤–∞—à–µ–π –±–∞—à–Ω–µ –≤—Å–µ —ç—Ç–∞–∂–∏ —É–∂–µ —Ä–∞—Å–ø–∏—Å–∞–Ω—ã!');
			}

			if (films.filter(i => {return i.user == ctx.user.id}).length >= 5) {

				return ctx.reply('—É –í–∞—Å —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–Ω–æ–≥–æ –Ω–∞–∫–ª–µ–µ–∫ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ. –î–∞–≤–∞–π—Ç–µ –¥—Ä—É–≥–∏–º —ç—Ç–∞–∂–∞–º –∏ –±–∞—à–Ω—è–º —Ç–æ–∂–µ –æ—Å—Ç–∞–≤–∏–º :)');
			}

			return ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–∂, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –í—ã –≥–æ—Ç–æ–≤—ã –Ω–∞–∫–ª–µ–∏—Ç—å –∑–∞—â–∏—Ç–Ω—É—é –ø–ª–µ–Ω–∫—É:',

				Markup.inlineKeyboard(

					films.map(i => {

						if (i.user) {

							return [Markup.callbackButton(`${i.floor} —ç—Ç. - —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞`, 'none')]
						}
						else {

							return [Markup.callbackButton(`${i.floor} —ç—Ç. (${i.tower})`, `{"film":{"id": ${i.id}, "rid": "${i._rid}"}}`)]
						}
					})

				).extra()
			);
		});
	});
}



function mw_kick_kbk(ctx, next) {

	if ((ctx.user.id == 861155720) || (ctx.user.id == 696690338)) {

		if (ctx.isPrivate) {

			return ctx.reply('[[[–ù–ï–ò–ó–í–ï–°–¢–ù–ê–Ø –û–®–ò–ë–ö–ê]]] –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ–∏–∑–æ—à–µ–ª –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–±–æ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ');
		}

		return ctx.bot.telegram.kickChatMember(ctx.chat.id, ctx.user.id).catch(trace_err(ctx.chat, ctx.user)).then(() => ctx.deleteMessage());
	}

	return next(ctx);
}



function mw_hide_leaving(ctx, next) {

	return ctx.deleteMessage().catch(trace_err(ctx.chat, ctx.user));
}



function mw_hide_kick(ctx, next) {

	if (ctx.user.id == 721787346) {

		return ctx.deleteMessage().catch(trace_err(ctx.chat, ctx.user));
	}

	return next(ctx);
}



function mw_kick_out(uid, cid) {

	return (ctx) => {

		return ctx.db.select({from: 'chat'}).then(chats => {

			return chats.filter(i => cid == 'all' || cid == i.id).reduce((rv, i) => {

				return rv.then(() => {

					return ctx.bot.telegram.kickChatMember(i.id, uid).then(() => {

						return ctx.bot.telegram.sendMessage(CHT_ATTN, `KICK-OUT:\nuser: ${uid}\nfrom chat: ${i.id} (${i.title})`);
					
					}, err => {

						return ctx.bot.telegram.sendMessage(CHT_ATTN, `FAILURE TO KICKOUT: ${err}\nuser: ${uid}\nfrom chat: ${i.id} (${i.title})`);
					});

				}).catch(trace.error);

			}, ctx.bot.telegram.sendMessage(CHT_ATTN, JSON.stringify(chats, null, "\t")));
		})
	}
}



function mw_cms_remove(ctx) {

	let data = JSON.parse(ctx.update.callback_query.message.text);
	trace.info('REMOVING CMS ITEM', data);

	/* ATTENTION! - needs to be updated to new WEBFLOW MW */

	return ctx.web.wf.cms_hide_remove(data[1]._cid, data[1]._id)
		.then(() => ctx.reply(`CMS ITEM REMOVE: success\n(item: ${data[1].name})`))
		.catch(err => ctx.reply(`CMS ITEM REMOVE: failure\n(err: ${toString(err)})`));
}



function mw_cms_unhide(ctx) {

	let data = JSON.parse(ctx.update.callback_query.message.text);
	trace.info('UNHIDING CMS ITEM', data);

	/* ATTENTION! - needs to be updated to new WEBFLOW MW */

	return ctx.web.wf.cms_unhide(data[1]._cid, data[1]._id)
		.then(() => ctx.reply(`CMS ITEM UNHIDE: success\n(item: ${data[1].name})`))
		.catch(err => ctx.reply(`CMS ITEM UNHIDE: failure\n(err: ${toString(err)})`));
}



function stat(ctx) {

    console.log("\n\nMIDDLEWARE: STAT");

    return Promise.all(

		[
			'select count(*) as users from user where out_owned.size()>0',
			'select count(*) as apts from apartment where in_owned.size()>0',
			'select sum(size) as size from apartment where in_owned.size()>0'
		]
        .map(i => ctx.db.query_one(i).then(res => {

            console.log(`\n\nQ.RESPONSE: ${JSON.stringify(res, null, '\t')}\nDATA: ${JSON.stringify(res['@data'], null, '\t')}`);
            return ctx.reply(JSON.stringify(res['@data'] || res, null, '\t'));

        }, err => err))
    )
    .then(result => ctx.reply(JSON.stringify(result, null, "\t")));
}



function this_chat(ctx) {

    return ctx.reply(toString(ctx.chat))
        .then(() => ctx.db.select({from: 'chat', where: {id: ctx.chat.id}}))
        .then(res => res.length > 0 ? null : ctx.db.insert('chat', ctx.chat));
}





function mw_send_correction(ctx) {

	let nCount = 0

	return ctx.db
		.query('select *, user.id as chat, apts.id as apt_ids from wash_budget_2020_03 where budget/window_count < 1000 and budget <= 2000')
		.then(requests => Promise.allSettled(

			requests.map(i => messages
				.wash_windows_budget_correction(ctx)
				.with(i)
				.keyboard({v: i.budget})
				.send(i.chat)
				.then(() => ++nCount)
				.catch(trace.error_with(i))
			)
		))
		.then(() => ctx.reply(`Done: ${nCount} messages`))
}


function mw_budget_correction_total(ctx) {

	return ctx
		.editMessageReplyMarkup()
		.then(() => ctx.reply('O–∫! –í–∞—à –æ—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç: "–∑–∞ –≤—Å—é –∫–≤–∞—Ä—Ç–∏—Ä—É".\n\n–°–ø–∞—Å–∏–±–æ!'));
}


function mw_budget_correction_single(ctx) {

	let data = decode_callback(ctx)
		data = data && data.data && data.data.v

	if (data > 0) {

		return ctx.user
			.correct_wash_budget(data)
			.then(() => ctx.editMessageReplyMarkup())
			.then(() => ctx.reply('O–∫! –í–∞—à –æ—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç: "–∑–∞ 1 –æ–∫–Ω–æ".\n\n–°–ø–∞—Å–∏–±–æ!'))
			.catch(trace.error)
	}

	return ctx.reply("–£–ø—Å... –∫–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞.").finally(() => trace.error(data, ctx.message));
}



function mw_broadcast_preview(ctx) {

	let tag = ctx.message.text && ctx.message.text.match(/\/\w+\s(\w+)/)
		tag = tag && tag[1]
	
	if (tag) {

		return ctx.db
			.select_one({select: "*, users.size() as user_count", from: CLASSES.BROADCAST, where: {id: tag}})
			.then(msg => msg || ctx.reply('NOT FOUND'))
			.then(msg => msg && msg.id && msg.text && messages
				.broadcast_preview(ctx)
				.with(msg)
				.keyboard({id: tag})
				.say()
			)
	}
}





function mw_broadcast(ctx) {

	let cb = decode_callback(ctx);
	let tag = cb && cb.data && cb.data.id;

	if (tag) {

        setTimeout((db, tg, tag) => db
            .select_one({select: "*, users.id as targets", from: CLASSES.BROADCAST, where: {id: tag}})
            .then(msg => tg.sendMessage(202234105, `STARTING broadcast tag=${tag}`).then(() => msg))
            .then(msg => broadcast(tg, msg))
            .then(({result, err}) => {

                trace.info(result)
                if (err) trace.error(err)                
                return Promise.allSettled([
                    tg.sendMessage(202234105, `DONE.\n\nOK = ${result.count_ok}\nERR = ${result.count_err}`),
                    db.insert(CLASSES.JOB_REPORT, result).then(console.log, trace.error)
                ])
            })
            .catch(trace.error)

        , 1000, ctx.db, ctx.bot.telegram, tag)

        return ctx.reply('ok, accepted: ' + tag)
	}

	return ctx.reply(`TAG IS NOT DEFINED`)
}





function mw_wash_confirmatiom(ctx) {

    return ctx.reply('–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç! –î–∞–Ω–Ω—ã–π –æ–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç, —Ç–∞–∫ –∫–∞–∫ —É—Ç—Ä–∞—Ç–∏–ª —Å–≤–æ—é –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å.')
}





function mw_wash_vote_antirain(ctx) {

    let answer = ctx.update.callback_query.data.split(':')[1]

    if (answer === 'yes' || answer === 'no') {

        return ctx.db
            .command(`update wash_budget_2020_03 set vote_antirain="${answer === 'yes' ? true : false}" where id=${ctx.user.id}`)
            .then(() => {

                ctx.editMessageReplyMarkup();
                return ctx.reply(`–û–∫, —Å–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç.\n\n${ answer === 'yes' ? '–Ø –±—É–¥—É –∏–º–µ—Ç—å –≤–∞—Å –≤ –≤–∏–¥—É, –µ—Å–ª–∏ –æ—Ç –ø–æ–¥—Ä—è–¥—á–∏–∫–∞ –ø–æ—Å—Ç—É–ø–∏—Ç –ö–ü –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∞–Ω—Ç–∏–¥–æ–∂–¥—ë–º' : '(–æ—Ç–≤–µ—Ç: "–∞–Ω—Ç–∏–¥–æ–∂–¥—å –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω")' }`);
            })
            .catch(err => {

                trace.error(err);
                return ctx.reply(`–£–ø—Å!... –∫–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–ª–∞: ${JSON.stringify(err)}`)
            })
    }

    return ctx.reply('–£–ø—Å... –∫–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞: —Ç–∞–∫–æ–π –æ—Ç–≤–µ—Ç –æ–∫–∞–∑–∞–ª—Å—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º. –°–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, @fedor_presnya - –µ–º—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –±—É–¥–µ—Ç —É–∑–Ω–∞—Ç—å –æ–± —ç—Ç–æ–º.')
}





function mw_wash_broadcast(ctx) {

    const keyboard = Markup.inlineKeyboard([
      Markup.urlButton('–î–æ–≥–æ–≤–æ—Ä –∏ –æ–ø–ª–∞—Ç–∞', `http://bot-sosed.herokuapp.com/request/${ctx.user.id}`)
    ])

    return ctx.db
        .query(`select from wash_budget_2020_03 where uniq_pay_id = 111`)
        .then(reqs => Promise.all(reqs.map(i => ctx.reply('–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–≥–≤–æ—Ä–∞ –∏ –æ–ø–ª–∞—Ç—ã –≤–∞—à–µ–≥–æ —É—á–∞—Å—Ç–∏—è –≤ –º–æ–π–∫–µ –æ–∫–æ–Ω –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É: ', Extra.markup(keyboard)))))
}





function mw_alp_contacts(ctx) {

    let cmd = ctx.update.message.text.match(/^[\\/–∞-—èc]+\s*(\d+)/i)
    let track = cmd && cmd[1]
    let tower = "#13:0"

    if (track) {

        return ctx.db
            .query(`select user:{@rid, *, !out_*, !in_*}, apts:{@rid, *, !out_*, !in_*}, apts.tower.name as tower, apts.windows as windows, apts.floor as floor from (select user, apts from wash_budget_2020_03 where money_received = true unwind apts) where apts.tower = ${tower} and ${track} in apts.windows order by floor desc`)
            .then(result => result.map(i => {i.user = new oUser(ctx.db, i.user); return i}))
            .then(result => {

                return ctx.reply(`<b>–í–∏—Å–∫–∞ ${track}</b>\n\n` + toText(result, `<b>{floor} —ç—Ç.:</b> {user:{link}}\n\n`), Extra.HTML())

            }).catch(err => {

                return ctx.reply(`Error: ${err}`);
            });
    }

    return ctx.reply('–ù—É–∂–µ–Ω –Ω–æ–º–µ—Ä –≤–∏—Å–∫–∏');
};





function mw_santa(ctx) {

    return ctx.db
        .query(`select from santa where id = ${ctx.user.id}`)
        .then(r => r.length && mw_santa_get || say(Date.now() < Date.parse("2020-12-30 15:00:00 GMT+3") ? 'santa_invitation' : 'santa_is_over', null, {}))
        .then(action => action(ctx))
}





function mw_santa_sendout_reminder(ctx) {

    return ctx.db
        .query(`select id from santa let $p = (select from santa where peer_id = $parent.$current.id) where $p.size() < 1`)
        .then(u => u.map(i => i.id))
        .then(u => messages
                    .santa_reminder(ctx)
                    .keyboard({})
                    .broadcast(u)
                    .then(() => trace.info('SANTA REMINDER', u))
                    .catch(trace.error_with(u)))
        .catch(trace.error)
}





function mw_santa_get(ctx) {
    
    console.log('mw_santa_get')

    return ctx.db
        .santa_get_peer(ctx.user)
        .then(peer => messages.santa_peer(ctx).with(peer).say())
        .catch(err => {

            trace.error(err, ctx.user);
            return ctx.reply('–£–ø—Å! –ö–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ :(\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑, –∏ –µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, —Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ @fedor_pavlov')
        })
}





function mw_santa_clear(ctx) {

    return ctx.editMessageReplyMarkup();
}





function mw_santa_sendout_ready_buttons(ctx) {

    return ctx.db
        .query(`select id from santa`)
        .then(u => u.map(i => i.id))
        .then(u => messages
                    .santa_ready_button(ctx)
                    .keyboard({})
                    .broadcast(u)
                    .then(() => trace.info('SANTA READY BUTTON', u))
                    .catch(trace.error_with(u)))
        .catch(trace.error)
}





function mw_santa_ready(ctx) {

    return ctx.db
        .query_one(`select user:{*}, user.out_owned[0].in:{id, tower:{name}} as apt from santa where peer_id = ${ctx.user.id}`)
        .then(u => { u.user = new oUser(ctx.db, u.user); return u})
        .then(u => messages
                .santa_gift_is_waiting(ctx).with(u).send(u.user.id)
                .then(() => messages.santa_thankyou(ctx).with(u).say())
                .then(() => ctx.editMessageReplyMarkup())
                .then(() => trace.info('SANTA GIFT IS READY', { from: ctx.user, to: u.user })))
        .catch(trace.error)
}





function mw_login(ctx) {

    console.log('Login test')
    return ctx.reply('Say hi!', Extra.markup(m => m.inlineKeyboard([[ m.loginButton('–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É', 'https://presnya.shop/login') ]])))
}





function mw_wash_windows(ctx) {

    /*
    return ctx.reply(
        `–õ–µ—Ç–Ω—è—è –º–æ–π–∫–∞ –æ–∫–æ–Ω —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–Ω–∞ –¥–ª–∏–ª–∞—Å—å —Å –∏—é–Ω—è –ø–æ –∏—é–ª—å. –°–ª–µ–¥—É—é—â–∞—è –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 6-–µ —Å–µ–Ω—Ç—è–±—Ä—è, –∞ —Å–±–æ—Ä –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤ –Ω–∞—á–Ω—ë—Ç—Å—è –≤ –∞–≤–≥—É—Å—Ç–µ. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º –≤–æ—Ç —Ç—É—Ç: @presnya_city_news`
    )*/

    /*
    return ctx.reply(
        `–û—Å–µ–Ω–Ω—è—è –º–æ–π–∫–∞ –æ–∫–æ–Ω —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–Ω–∞ –ø—Ä–æ–≤–æ–¥–∏–ª–∞—Å—å —Å —Å–µ–Ω—Ç—è–±—Ä—è –ø–æ –æ–∫—Ç—è–±—Ä—å. –°–ª–µ–¥—É—é—â–∞—è –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≤–µ—Å–Ω—É 2022 –≥–æ–¥–∞, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–∑–≤–æ–ª—è—Ç –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è. –°–±–æ—Ä –∑–∞–∫–∞–∑–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –≤ –º–∞—Ä—Ç–µ 2022. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º –≤ –Ω–æ–≤–æ—Å—Ç–Ω–æ–º –∫–∞–Ω–∞–ª–µ: @presnya_city_news`
    )*/

    return ctx.db
        .query(`select expand(set(out("owned"))) from user where id=${ctx.user.id}`)
        .then(apts => { trace.info(apts); return apts })
        .then(apts => ctx.reply(
            `–ú–æ–π–∫–∞ –æ–∫–æ–Ω —Å –≤–Ω–µ—à–Ω–µ–π —Å—Ç–æ—Ä–æ–Ω—ã —Å–∏–ª–∞–º–∏ –∞–ª—å–ø–∏–Ω–∏—Å—Ç–æ–≤ –ª–µ—Ç–æ–º 2022:\n\n${apts.length > 1 ? '–í–∞—à–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã:' : '–í–∞—à–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞:'}${apts.reduce((rv, x) => `${rv}\n<b>${x.id}</b> (${x.windows.length} –æ–∫–æ–Ω, ${x.floor} —ç—Ç)`, '')}\n\n–î–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç:\n<b>06.06-19.06:</b> –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –±–∞—à–Ω—è\n<b>20.06-03.07:</b> –ó–∞–ø–∞–¥–Ω–∞—è –±–∞—à–Ω—è\n<b>04.07-17.07:</b> –í–æ—Å—Ç–æ—á–Ω–∞—è –±–∞—à–Ω—è\n\n–ß—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑, –æ–ø–ª–∞—Ç–∏—Ç—å —Å—á–µ—Ç –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑" –ø–æ–¥ —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –ï—Å–ª–∏ –ø–æ –∫–∞–∫–∏–º-—Ç–æ –ø—Ä–∏—á–∏–Ω–∞–º –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ –º–æ–∂–Ω–æ –∑–∞–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—á–∫—É https://presnya.shop`,
             Extra.HTML().markup(m => m.inlineKeyboard([[ m.loginButton('–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑', 'https://presnya.shop/login') ]]))
        ))
}





function mw_unknown_message(ctx, next) {

	if (!ctx.isPrivate) return next(ctx);

	return mw_menu(ctx, next).then(() => {

		trace.info(`UNKNOWN MESSAGE [from = ${ctx.user.name}]`, ctx.user, ctx.update.message);

		return ctx.bot.telegram.sendMessage(
			CHT_ATTN,
            JSON.stringify({

				ts: Date.now(),
				message: ctx.update.message.message_id,
                text: ctx.update.message.text,
				sender: ctx.update.message.from,
				chat: ctx.update.message.chat,
				photo: ctx.update.message.photo && ctx.update.message.photo.reduce((rv, x) => { if (rv.file_size && rv.file_size > x.file_size) return rv; return x }, {})

			}, null, "\t"),
			Markup.inlineKeyboard([[Markup.callbackButton('–æ—Ç–≤–µ—Ç–∏—Ç—å', 'reply')]]).extra()
		);
	});
}





function mw_window_show_contact(ctx) {

    let track = ctx.message.text.match(/^\s*\d{3}\s|\s\d{3}\s*$/);
    let floor = ctx.message.text.match(/^\s*\d{1,2}\s|\s\d{1,2}\s*$/);

    if (track && floor) {

        track = track[0].trim()
        floor = floor[0].trim()

        trace.info('REQUEST FOR CONTACT', { track, floor })

        return ctx.db
            .query(`select expand(clean_windows_get_contact(${track}, ${floor}))`)
            .then(contacts => {

                if (!Array.isArray(contacts) || contacts.length < 1) {

                    return ctx.reply(`–ö–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —ç—Ç–∞–∂–∞ ${floor} –Ω–∞ –≤–∏—Å–∫–µ ${track} –Ω–∞ –Ω–∞–π–¥–µ–Ω`)
                }

                return Promise.all(

                    contacts.map(i => messages.window_customer_contact(ctx).with(i).say().catch(trace.error))
                )
            })
            .catch(err => {

                trace.error('REQUEST FOR CONTACT', err)
                return ctx.reply(`–°–ª—É—á–∏–ª–∞—Å—å –æ—à–∏–±–∫–∞:\n\n${JSON.stringify(err)}`)
            })
    }

    return mw_unknown(ctx);
}